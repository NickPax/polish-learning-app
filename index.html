<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PolskiCore ‚Äì Real Polish Comprehension</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* === EXACT SAME CSS AS BEFORE === */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
:root {
--primary: #7e22ce;
--secondary: #6b21a8;
--success: #4ade80;
--light-bg: #f8f9fa;
--dark-bg: #121826;
--card-light: #ffffff;
--card-dark: #1e293b;
--text-light: #212529;
--text-dark: #f1f5f9;
--shadow-light: rgba(0, 0, 0, 0.1);
--shadow-dark: rgba(0, 0, 0, 0.3);
--border-light: #dee2e6;
--border-dark: #334155;
--option-bg-light: white;
--option-bg-dark: #334155;
--correct: #4ade80;
--incorrect: #f87171;
--feedback-correct-light: #d1fae5;
--feedback-correct-dark: #064e3b;
--feedback-incorrect-light: #fee2e2;
--feedback-incorrect-dark: #7f1d1d;
--score-badge-bg: #fbbf24;
--score-badge-text: #1e293b;
}
body {
background: var(--bg);
color: var(--text);
min-height: 100vh;
padding: 20px;
transition: background-color 0.3s, color 0.3s;
}
.container {
max-width: 900px;
margin: 0 auto;
}
header {
text-align: center;
padding: 20px 0;
margin-bottom: 30px;
display: flex;
justify-content: space-between;
align-items: center;
}
.logo-container {
text-align: center;
flex: 1;
}
h1 {
font-size: 2.5rem;
color: var(--primary);
margin-bottom: 10px;
text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.subtitle {
color: var(--secondary);
font-size: 1.1rem;
max-width: 600px;
margin: 0 auto;
}
.theme-toggle {
background: var(--card);
border: 1px solid var(--border);
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 2px 4px var(--shadow);
transition: all 0.3s;
opacity: 0.8; /* Less obtrusive */
}
.theme-toggle:hover {
opacity: 1;
transform: scale(1.1);
}
.theme-toggle i {
font-size: 0.9rem;
}
.progress-container {
background: var(--card);
border-radius: 12px;
padding: 20px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
border: 1px solid var(--border);
}
.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
font-weight: 600;
color: var(--secondary);
}
.progress-bar {
height: 12px;
background: var(--option-bg);
border-radius: 6px;
overflow: hidden;
border: 1px solid var(--border);
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--primary), var(--success));
border-radius: 6px;
width: 0%;
transition: width 0.5s ease;
}
.points-display {
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
margin-top: 15px;
font-size: 1.2rem;
font-weight: 700;
color: var(--warning);
}
.exercise-container {
background: var(--card);
border-radius: 12px;
padding: 30px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
min-height: 300px;
display: flex;
flex-direction: column;
border: 1px solid var(--border);
}
.exercise-title {
font-size: 1.5rem;
margin-bottom: 20px;
color: var(--secondary);
display: flex;
align-items: center;
gap: 10px;
justify-content: space-between;
}
.topic-name {
font-weight: 600;
color: var(--primary);
}
.back-btn {
background: none;
border: none;
color: var(--secondary);
font-weight: 600;
cursor: pointer;
display: flex;
align-items: center;
gap: 5px;
}
.back-btn:hover {
color: var(--primary);
}
.exercise-content {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
}
.missing-word-exercise {
text-align: center;
}
.sentence {
font-size: 1.4rem;
line-height: 1.6;
margin-bottom: 25px;
padding: 15px;
background: var(--bg-sentence);
border-radius: 8px;
border-left: 4px solid var(--primary);
}
.options-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 12px;
margin-top: 20px;
}
.option-btn {
padding: 12px 15px;
border: 2px solid var(--border);
border-radius: 8px;
background: var(--option-bg);
font-size: 1.1rem;
cursor: pointer;
transition: all 0.2s;
font-weight: 600;
color: var(--text);
}
.option-btn:hover:not(:disabled) {
border-color: var(--primary);
transform: translateY(-2px);
box-shadow: 0 4px 8px var(--shadow);
}
.option-btn:disabled {
opacity: 0.8;
cursor: not-allowed;
}
.option-btn.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.option-btn.correct {
background: var(--correct);
border-color: var(--correct);
color: white;
}
.option-btn.incorrect {
background: var(--incorrect);
border-color: var(--incorrect);
color: white;
}
.tts-exercise {
text-align: center;
}
.audio-controls {
display: flex;
justify-content: center;
gap: 15px;
margin: 25px 0;
}
.play-btn {
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--primary);
color: white;
border: none;
font-size: 1.5rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 4px 12px var(--shadow);
transition: all 0.2s;
}
.play-btn:hover {
background: var(--secondary);
transform: scale(1.05);
}
.play-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}
.topics-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 15px;
margin-top: 20px;
}
.topic-card {
padding: 20px;
border: 2px solid var(--border);
border-radius: 10px;
background: var(--option-bg);
cursor: pointer;
transition: all 0.2s;
text-align: center;
font-weight: 600;
color: var(--text);
}
.topic-card:hover:not(.selected):not(.locked) {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 4px 8px var(--shadow);
}
.topic-card.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.topic-card.locked {
opacity: 0.8;
cursor: not-allowed;
}
.feedback {
margin-top: 20px;
padding: 15px;
border-radius: 8px;
text-align: center;
font-weight: 600;
display: none;
}
.feedback.correct {
background: var(--feedback-correct);
color: var(--feedback-correct-text);
display: block;
}
.feedback.incorrect {
background: var(--feedback-incorrect);
color: var(--feedback-incorrect-text);
display: block;
}
.navigation {
display: flex;
justify-content: space-between;
margin-top: 20px;
}
.btn {
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.btn-prev {
background: var(--border);
color: var(--text);
}
.btn-prev:hover {
background: var(--primary);
color: white;
}
.btn-next {
background: var(--primary);
color: white;
}
.btn-next:hover {
background: var(--secondary);
}
.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}
.completion-screen, .topic-selection-screen, .level-selection-screen, .mode-selection-screen {
text-align: center;
padding: 40px 20px;
}
.completion-screen h2, .topic-selection-screen h2, .level-selection-screen h2, .mode-selection-screen h2 {
font-size: 2.2rem;
margin-bottom: 20px;
}
.final-score {
font-size: 1.8rem;
font-weight: 700;
color: var(--warning);
margin: 20px 0;
}
.action-buttons {
margin-top: 25px;
display: flex;
justify-content: center;
gap: 15px;
flex-wrap: wrap;
}
.restart-btn, .continue-btn, .new-topic-btn, .full-restart-btn {
background: var(--success);
color: white;
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.restart-btn:hover, .continue-btn:hover, .new-topic-btn:hover, .full-restart-btn:hover {
background: #3ab7e4;
transform: scale(1.03);
}
.topic-options {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 20px;
margin-top: 30px;
}
.topic-option {
padding: 25px 15px;
background: var(--card);
border: 2px solid var(--border);
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
font-weight: 600;
color: var(--text);
position: relative;
}
.topic-option:hover {
border-color: var(--primary);
transform: translateY(-5px);
box-shadow: 0 6px 12px var(--shadow);
}
.topic-option i {
display: block;
font-size: 2rem;
margin-bottom: 10px;
color: var(--primary);
}
.score-badge {
position: absolute;
top: 10px;
right: 10px;
background: var(--score-badge-bg);
color: var(--score-badge-text);
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.8rem;
font-weight: bold;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.hidden {
display: none;
}
@media (max-width: 600px) {
.exercise-container {
padding: 20px;
}
h1 {
font-size: 2rem;
}
.sentence {
font-size: 1.2rem;
}
.options-container, .topics-container, .topic-options {
grid-template-columns: 1fr;
}
.header {
flex-direction: column;
gap: 15px;
}
.score-badge {
width: 24px;
height: 24px;
font-size: 0.7rem;
}
.action-buttons {
gap: 10px;
}
.restart-btn, .new-topic-btn {
padding: 10px 20px;
font-size: 1rem;
}
.theme-toggle {
width: 40px;
height: 40px;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo-container">
<h1><i class="fas fa-language"></i> PolskiCore</h1>
<p class="subtitle">Master real Polish through high-frequency vocabulary and authentic listening.</p>
</div>
<div class="theme-toggle" id="theme-toggle">
<i class="fas fa-moon"></i>
</div>
</header>

<!-- LEVEL SELECTION -->
<div class="level-selection-screen" id="level-selection-screen">
<h2>Select Your Comprehension Level</h2>
<p>Choose a vocabulary set optimized for real-world listening and reading.</p>
<div class="topic-options" id="level-options-container"></div>
</div>

<!-- MODE SELECTION -->
<div class="mode-selection-screen hidden" id="mode-selection-screen">
<h2>Choose Your Practice Mode</h2>
<p>Select how you want to practice:</p>
<div class="topic-options" id="mode-options-container">
<!-- Filled by JS -->
</div>
</div>

<!-- TOPIC SELECTION (for Listening Mode) -->
<div class="topic-selection-screen hidden" id="topic-selection-screen">
<h2>Choose a Practice Context</h2>
<p>Vocabulary comes from your selected level.</p>
<div class="topic-options" id="topic-options-container"></div>
</div>

<!-- PROGRESS & EXERCISE -->
<div class="progress-container hidden" id="progress-container">
<div class="progress-header">
<span>Progress</span>
<span id="progress-text">0/5</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
<div class="points-display">
<i class="fas fa-star"></i>
<span id="points">0</span> Points
</div>
</div>

<div class="exercise-container hidden" id="exercise-container"></div>

<!-- COMPLETION -->
<div class="completion-screen hidden" id="completion-screen">
<h2 id="completion-message">Great Job! üåü</h2>
<p>You've completed the topic!</p>
<div class="final-score">Your Score: <span id="final-score">0</span>/50 points</div>
<div class="action-buttons">
<button class="new-topic-btn" id="new-topic-btn">Practice Another Topic</button>
<button class="restart-btn" id="restart-topic-btn">Retry This Topic</button>
<button class="btn" style="background:#64748b; margin-top:10px;" id="change-level-btn">Change Level</button>
</div>
</div>

<script>
// ‚úÖ FOUR COMPREHENSION-OPTIMIZED LEVELS (function words only)
const vocabLevels = {
  1: [
    {word: "tak", meaning: "yes"},
    {word: "nie", meaning: "no"},
    {word: "proszƒô", meaning: "please"},
    {word: "jest", meaning: "is"},
    {word: "ma", meaning: "has"},
    {word: "chce", meaning: "wants"},
    {word: "tu", meaning: "here"},
    {word: "teraz", meaning: "now"},
    {word: "no", meaning: "well"},
    {word: "bardzo", meaning: "very"}
  ],
  2: [
    {word: "my≈õlƒô", meaning: "I think"},
    {word: "wiem", meaning: "I know"},
    {word: "rozumiem", meaning: "I understand"},
    {word: "m√≥wi", meaning: "says"},
    {word: "ale", meaning: "but"},
    {word: "bo", meaning: "because"},
    {word: "wiƒôc", meaning: "so"},
    {word: "ju≈º", meaning: "already"},
    {word: "jeszcze", meaning: "still"},
    {word: "mo≈ºe", meaning: "can/may"}
  ],
  3: [
    {word: "pewnie", meaning: "probably"},
    {word: "chyba", meaning: "maybe"},
    {word: "poniewa≈º", meaning: "because (formal)"},
    {word: "jednak", meaning: "however"},
    {word: "mimo ≈ºe", meaning: "although"},
    {word: "gdyby", meaning: "if (hypothetical)"},
    {word: "wa≈ºne", meaning: "important"},
    {word: "trudno", meaning: "it's difficult"},
    {word: "w≈Ça≈õnie", meaning: "just"},
    {word: "raczej", meaning: "rather"}
  ],
  4: [
    {word: "przecie≈º", meaning: "after all"},
    {word: "w≈Ça≈õciwie", meaning: "actually"},
    {word: "oczywi≈õcie", meaning: "of course"},
    {word: "niestety", meaning: "unfortunately"},
    {word: "na szczƒô≈õcie", meaning: "fortunately"},
    {word: "powinien", meaning: "should"},
    {word: "m√≥g≈Çby", meaning: "could"},
    {word: "trochƒô", meaning: "a little"},
    {word: "serio?", meaning: "seriously?"},
    {word: "naprawdƒô", meaning: "really"}
  ]
};

// ‚úÖ AUTHENTIC LISTENING EXERCISES (topic-based, English options)
const listeningExercises = {
  food: [
    {audioText: "Poproszƒô butelkƒô wody.", topics: ["Ordering drinks", "Asking for directions", "Complaining about service", "Requesting the bill"], correct: 0, explanation: "The speaker is ordering a bottle of water."},
    {audioText: "Zupa jest wy≈õmienita! Poproszƒô rachunek.", topics: ["Praising food", "Complaining", "Asking for directions", "Ordering clothes"], correct: 0, explanation: "The speaker praises the soup and asks for the bill."},
    {audioText: "Jestem wegetarianinem. Czy macie dania wegetaria≈Ñskie?", topics: ["Dietary needs", "Allergies", "Cooking at home", "Fast food"], correct: 0, explanation: "The speaker asks about vegetarian options."}
  ],
  travel: [
    {audioText: "Gdzie jest najbli≈ºszy dworzec?", topics: ["Asking for directions", "Buying tickets", "Checking into a hotel", "Renting a car"], correct: 0, explanation: "The speaker asks for the nearest train station."},
    {audioText: "Przepraszam, jak doj≈õƒá do muzeum?", topics: ["Asking for directions", "Buying souvenirs", "Taking photos", "Booking tours"], correct: 0, explanation: "The speaker asks how to get to the museum."},
    {audioText: "PociƒÖg do Krakowa odje≈ºd≈ºa z peronu 3.", topics: ["Train announcements", "Flight information", "Bus schedules", "Taxi services"], correct: 0, explanation: "This is a train departure announcement."}
  ],
  family: [
    {audioText: "To moja siostra.", topics: ["Introducing family", "Talking about work", "Discussing hobbies", "Describing weather"], correct: 0, explanation: "The speaker introduces their sister."},
    {audioText: "M√≥j tata pracuje jako lekarz.", topics: ["Family members", "Professions", "Daily routine", "Hobbies"], correct: 1, explanation: "The speaker talks about their father's profession."},
    {audioText: "Moje dziadkowie mieszkajƒÖ w ma≈Çej wsi.", topics: ["Family members", "Travel plans", "Housing", "Weather"], correct: 0, explanation: "The speaker talks about their grandparents."}
  ],
  animals: [
    {audioText: "Pies szczeka g≈Ço≈õno.", topics: ["Describing animals", "Talking about weather", "Discussing food", "Asking for help"], correct: 0, explanation: "The speaker describes a dog barking loudly."},
    {audioText: "Ptak fruwa wysoko w niebie.", topics: ["Describing animals", "Talking about travel", "Discussing hobbies", "Asking for directions"], correct: 0, explanation: "The speaker describes a bird flying high in the sky."},
    {audioText: "W lesie mo≈ºna spotkaƒá jelenie i lisy.", topics: ["Forest animals", "City life", "Ocean creatures", "Farm animals"], correct: 0, explanation: "The speaker describes forest animals."}
  ],
  work: [
    {audioText: "Mam wa≈ºne spotkanie z szefem.", topics: ["Work meetings", "Social events", "Medical appointments", "Travel plans"], correct: 0, explanation: "The speaker mentions an important meeting with their boss."},
    {audioText: "Czy m√≥g≈Çby≈õ przes≈Çaƒá mi tƒô prezentacjƒô mailem?", topics: ["Work requests", "Social invitations", "Complaints", "Personal news"], correct: 0, explanation: "The speaker politely requests a presentation via email."},
    {audioText: "Firma rekrutuje nowych pracownik√≥w do dzia≈Çu marketingu.", topics: ["Job openings", "Company news", "Office gossip", "Customer complaints"], correct: 0, explanation: "The sentence announces job openings in marketing."}
  ],
  health: [
    {audioText: "Mam silny b√≥l brzucha i md≈Ço≈õci.", topics: ["Illness symptoms", "Travel plans", "Food preferences", "Weather conditions"], correct: 0, explanation: "The speaker describes stomach pain and nausea."},
    {audioText: "Powiniene≈õ piƒá wiƒôcej wody i mniej kawy.", topics: ["Health advice", "Work instructions", "Social suggestions", "Shopping tips"], correct: 0, explanation: "The speaker gives hydration advice."},
    {audioText: "Idƒô na wizytƒô do dentysty.", topics: ["Medical appointments", "Social events", "Work meetings", "Travel plans"], correct: 0, explanation: "The speaker mentions a dentist appointment."}
  ],
  shopping: [
    {audioText: "Ile to kosztuje ta kurtka?", topics: ["Asking for price", "Asking for size", "Returning items", "Opening hours"], correct: 0, explanation: "The speaker asks for the price of a jacket."},
    {audioText: "Czy macie te buty w rozmiarze 40?", topics: ["Asking for size", "Asking for price", "Product availability", "Store layout"], correct: 0, explanation: "The speaker asks if shoes are available in size 40."},
    {audioText: "Chcia≈Çbym zamieniƒá tƒô spodnie.", topics: ["Returning items", "Asking for discounts", "Requesting assistance", "Complaining about quality"], correct: 0, explanation: "The speaker wants to exchange trousers."}
  ],
  daily: [
    {audioText: "Kt√≥ra godzina?", topics: ["Asking for time", "Asking for directions", "Requesting help", "Making plans"], correct: 0, explanation: "The speaker asks what time it is."},
    {audioText: "Nie czujƒô siƒô dobrze. Mam gorƒÖczkƒô.", topics: ["Describing illness", "Making plans", "Talking about food", "Discussing weather"], correct: 0, explanation: "The speaker describes feeling unwell with a fever."},
    {audioText: "Idƒô do lekarza.", topics: ["Medical visits", "Work meetings", "Social events", "Shopping trips"], correct: 0, explanation: "The speaker says they're going to the doctor."}
  ],
  learning: [
    {audioText: "Nie rozumiem tego s≈Çowa.", topics: ["Language learning", "Work discussions", "Social conversations", "Shopping interactions"], correct: 0, explanation: "The speaker says they don't understand a word."},
    {audioText: "Jak siƒô m√≥wi 'apple' po polsku?", topics: ["Vocabulary questions", "Grammar questions", "Pronunciation practice", "Cultural questions"], correct: 0, explanation: "The speaker asks for a translation."},
    {audioText: "Czy mo≈ºesz to powt√≥rzyƒá?", topics: ["Requesting repetition", "Asking for clarification", "Making complaints", "Giving instructions"], correct: 0, explanation: "The speaker asks for repetition."}
  ],
  media: [
    {audioText: "Niestety, wczoraj dosz≈Ço do powodzi.", topics: ["Disaster news", "Sports results", "Entertainment news", "Weather forecast"], correct: 0, explanation: "The sentence reports a flood disaster."},
    {audioText: "Na szczƒô≈õcie nikt siƒô nie porani≈Ç.", topics: ["Good news", "Bad news", "Sports updates", "Political news"], correct: 0, explanation: "The speaker shares relief that no one was injured."},
    {audioText: "Wed≈Çug ankiety, 70% Polak√≥w popiera reformƒô.", topics: ["Survey results", "Opinion polls", "Election results", "Economic reports"], correct: 0, explanation: "The sentence presents survey results."}
  ]
};

// DOM elements
const levelSelectionScreen = document.getElementById('level-selection-screen');
const modeSelectionScreen = document.getElementById('mode-selection-screen');
const topicSelectionScreen = document.getElementById('topic-selection-screen');
const exerciseScreen = document.getElementById('exercise-container');
const progressContainer = document.getElementById('progress-container');
const completionScreen = document.getElementById('completion-screen');
const levelOptionsContainer = document.getElementById('level-options-container');
const modeOptionsContainer = document.getElementById('mode-options-container');
const topicOptionsContainer = document.getElementById('topic-options-container');
const themeToggle = document.getElementById('theme-toggle');

let currentLevel = 1;
let currentMode = null; // 'vocabulary' or 'listening'
let currentTopic = null;
let exercises = [];
let currentExercise = 0;
let points = 0;
let userAnswers = [];
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// Apply theme
applyTheme();
themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
themeToggle.addEventListener('click', () => {
  isDarkMode = !isDarkMode;
  localStorage.setItem('darkMode', isDarkMode);
  applyTheme();
  themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

function applyTheme() {
  const root = document.documentElement;
  if (isDarkMode) {
    root.style.setProperty('--bg', 'var(--dark-bg)');
    root.style.setProperty('--text', 'var(--text-dark)');
    root.style.setProperty('--card', 'var(--card-dark)');
    root.style.setProperty('--border', 'var(--border-dark)');
    root.style.setProperty('--option-bg', 'var(--option-bg-dark)');
    root.style.setProperty('--bg-sentence', 'rgba(30, 41, 59, 0.7)');
    root.style.setProperty('--shadow', 'var(--shadow-dark)');
    root.style.setProperty('--feedback-correct', 'var(--feedback-correct-dark)');
    root.style.setProperty('--feedback-correct-text', 'white');
    root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-dark)');
    root.style.setProperty('--feedback-incorrect-text', 'white');
    root.style.setProperty('--warning', '#fbbf24');
  } else {
    root.style.setProperty('--bg', 'var(--light-bg)');
    root.style.setProperty('--text', 'var(--text-light)');
    root.style.setProperty('--card', 'var(--card-light)');
    root.style.setProperty('--border', 'var(--border-light)');
    root.style.setProperty('--option-bg', 'var(--option-bg-light)');
    root.style.setProperty('--bg-sentence', '#f1f5ff');
    root.style.setProperty('--shadow', 'var(--shadow-light)');
    root.style.setProperty('--feedback-correct', 'var(--feedback-correct-light)');
    root.style.setProperty('--feedback-correct-text', 'var(--text-light)');
    root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-light)');
    root.style.setProperty('--feedback-incorrect-text', 'var(--text-light)');
    root.style.setProperty('--warning', '#f8961e');
  }
}

// Render level selection
function renderLevelSelection() {
  levelOptionsContainer.innerHTML = '';
  const levels = [
    {num: 1, name: "Core Survival & Spoken Glue"},
    {num: 2, name: "High-Frequency Expansion"},
    {num: 3, name: "Precision & Structural Control"},
    {num: 4, name: "Pragmatic & Nuance Control"}
  ];
  
  levels.forEach(level => {
    const el = document.createElement('div');
    el.className = 'topic-option';
    el.innerHTML = `<i class="fas fa-layer-group"></i> Level ${level.num}<br><small>${level.name}</small>`;
    el.onclick = () => {
      currentLevel = level.num;
      levelSelectionScreen.classList.add('hidden');
      renderModeSelection();
      modeSelectionScreen.classList.remove('hidden');
    };
    levelOptionsContainer.appendChild(el);
  });
}

// Render mode selection
function renderModeSelection() {
  modeOptionsContainer.innerHTML = '';
  const modes = [
    {type: 'vocabulary', name: "Vocabulary Practice", icon: "book", description: "Practice core function words with fill-in-the-blank exercises."},
    {type: 'listening', name: "Listening Practice", icon: "headphones", description: "Improve comprehension with authentic Polish sentences."}
  ];
  
  modes.forEach(mode => {
    const el = document.createElement('div');
    el.className = 'topic-option';
    el.innerHTML = `<i class="fas fa-${mode.icon}"></i>${mode.name}<br><small>${mode.description}</small>`;
    el.onclick = () => {
      currentMode = mode.type;
      modeSelectionScreen.classList.add('hidden');
      if (currentMode === 'vocabulary') {
        startVocabularyPractice();
      } else {
        renderTopicSelection();
        topicSelectionScreen.classList.remove('hidden');
      }
    };
    modeOptionsContainer.appendChild(el);
  });
}

// Render topic selection
function renderTopicSelection() {
  topicOptionsContainer.innerHTML = '';
  const topics = [
    {key: "food", name: "Food & Dining", icon: "utensils"},
    {key: "travel", name: "Travel & Directions", icon: "plane"},
    {key: "work", name: "Work & Office", icon: "briefcase"},
    {key: "daily", name: "Daily Life", icon: "home"},
    {key: "shopping", name: "Shopping", icon: "shopping-bag"},
    {key: "health", name: "Health & Body", icon: "heartbeat"},
    {key: "family", name: "Family & Friends", icon: "users"},
    {key: "city", name: "Cities & Places", icon: "city"},
    {key: "learning", name: "Learning Polish", icon: "book"},
    {key: "media", name: "News & Media", icon: "newspaper"}
  ];
  
  topics.forEach(topic => {
    const el = document.createElement('div');
    el.className = 'topic-option';
    el.innerHTML = `<i class="fas fa-${topic.icon}"></i>${topic.name}`;
    el.onclick = () => startTopicExercises(topic.key);
    topicOptionsContainer.appendChild(el);
  });
}

// Start vocabulary practice
function startVocabularyPractice() {
  progressContainer.classList.remove('hidden');
  exerciseScreen.classList.remove('hidden');
  completionScreen.classList.add('hidden');
  
  currentExercise = 0;
  points = 0;
  userAnswers = new Array(5).fill(null);
  
  // Generate 5 fill-in-the-blank exercises using level vocabulary
  const vocab = vocabLevels[currentLevel];
  exercises = [];
  
  for (let i = 0; i < 5; i++) {
    const item = vocab[i % vocab.length];
    const sentenceTemplates = [
      `To ___ moja ksiƒÖ≈ºka.`,
      `Chcƒô kawƒô, ___.`,
      `Nie ___ tego.`,
      `___ jest teraz?`,
      `On ___ samoch√≥d.`,
      `Idƒô ___ domu.`,
      `___ ju≈º poszed≈Ç?`,
      `To jest ___ wa≈ºne.`,
      `___ bo nie wiem.`,
      `___ ale to nie jest problem.`
    ];
    
    let sentence = sentenceTemplates[i % sentenceTemplates.length];
    // Replace blank with correct word to verify grammar
    const testSentence = sentence.replace("___", item.word);
    // Only use if it makes sense (basic check)
    if (testSentence.includes(item.word)) {
      // Create distractors from same level
      const distractors = vocab
        .filter(v => v.word !== item.word)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(v => v.word);
      
      const options = [item.word, ...distractors].sort(() => 0.5 - Math.random());
      const correct = options.indexOf(item.word);
      
      exercises.push({
        type: 'missing-word',
        sentence: sentence.replace("___", "________"),
        options,
        correct,
        explanation: `"${item.word}" means "${item.meaning}".`
      });
    }
  }
  
  document.getElementById('points').textContent = points;
  updateProgress();
  loadExercise(currentExercise);
}

// Start topic exercises (listening mode)
function startTopicExercises(topicKey) {
  topicSelectionScreen.classList.add('hidden');
  progressContainer.classList.remove('hidden');
  exerciseScreen.classList.remove('hidden');
  completionScreen.classList.add('hidden');
  
  currentTopic = topicKey;
  currentExercise = 0;
  points = 0;
  userAnswers = new Array(5).fill(null);
  
  // Generate 5 listening exercises
  const topicListening = listeningExercises[topicKey] || [];
  exercises = [];
  
  for (let i = 0; i < 5 && i < topicListening.length; i++) {
    exercises.push({...topicListening[i]});
  }
  
  // If we don't have 5, pad with more
  while (exercises.length < 5) {
    const item = topicListening[exercises.length % topicListening.length];
    exercises.push({...item});
  }
  
  document.getElementById('points').textContent = points;
  updateProgress();
  loadExercise(currentExercise);
}

// Load exercise
function loadExercise(index) {
  const ex = exercises[index];
  exerciseScreen.innerHTML = '';
  
  const title = document.createElement('div');
  title.className = 'exercise-title';
  title.innerHTML = `
    <span><i class="fas fa-${ex.type === 'missing-word' ? 'puzzle-piece' : 'headphones'}"></i> ${ex.type === 'missing-word' ? 'Fill in the Blank' : 'Listen & Identify Topic'}</span>
    <div>
      <span class="topic-name">${currentMode === 'vocabulary' ? 'Vocabulary Practice' : getTopicName(currentTopic)}</span>
      <button class="back-btn" id="back-to-mode-btn">
        <i class="fas fa-arrow-left"></i> ${currentMode === 'vocabulary' ? 'Back to Mode' : 'Back to Topics'}
      </button>
    </div>
  `;
  exerciseScreen.appendChild(title);
  
  setTimeout(() => {
    const backBtn = document.getElementById('back-to-mode-btn');
    if (backBtn) backBtn.onclick = () => {
      exerciseScreen.classList.add('hidden');
      progressContainer.classList.add('hidden');
      if (currentMode === 'vocabulary') {
        modeSelectionScreen.classList.remove('hidden');
      } else {
        topicSelectionScreen.classList.remove('hidden');
      }
    };
  }, 0);
  
  if (ex.type === 'missing-word') {
    renderMissingWordExercise(ex);
  } else {
    renderTTsExercise(ex);
  }
  
  addNavigation();
}

// Render missing word exercise
function renderMissingWordExercise(ex) {
  const content = document.createElement('div');
  content.className = 'exercise-content missing-word-exercise';
  
  const sentenceEl = document.createElement('div');
  sentenceEl.className = 'sentence';
  sentenceEl.textContent = ex.sentence;
  content.appendChild(sentenceEl);
  
  const optionsContainer = document.createElement('div');
  optionsContainer.className = 'options-container';
  ex.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    if (userAnswers[currentExercise] !== null) btn.disabled = true;
    btn.onclick = () => handleMissingWordAnswer(i, ex.correct, ex);
    optionsContainer.appendChild(btn);
  });
  content.appendChild(optionsContainer);
  
  const feedback = document.createElement('div');
  feedback.className = 'feedback';
  feedback.id = 'feedback';
  content.appendChild(feedback);
  
  exerciseScreen.appendChild(content);
}

// Handle missing word answer
function handleMissingWordAnswer(selected, correct, exercise) {
  userAnswers[currentExercise] = selected;
  if (selected === correct) {
    points += 10;
    document.getElementById('points').textContent = points;
  }
  
  document.querySelectorAll('.option-btn').forEach((btn, i) => {
    btn.disabled = true;
    if (i === selected) btn.classList.add(selected === correct ? 'correct' : 'incorrect');
    else if (i === correct) btn.classList.add('correct');
  });
  
  document.getElementById('feedback').textContent = exercise.explanation;
  document.getElementById('feedback').className = `feedback ${selected === correct ? 'correct' : 'incorrect'}`;
  
  // Speak correct sentence
  const fullSentence = exercise.sentence.replace("________", exercise.options[exercise.correct]);
  speakText(fullSentence);
  
  document.querySelector('.btn-next').disabled = false;
  scrollToNextButton();
}

// Render TTS exercise
function renderTTsExercise(ex) {
  const content = document.createElement('div');
  content.className = 'exercise-content tts-exercise';
  
  const instruction = document.createElement('p');
  instruction.textContent = 'Listen to the Polish sentence and select the correct topic:';
  instruction.style.marginBottom = '20px';
  instruction.style.fontSize = '1.1rem';
  content.appendChild(instruction);
  
  const audioControls = document.createElement('div');
  audioControls.className = 'audio-controls';
  const playBtn = document.createElement('button');
  playBtn.className = 'play-btn';
  playBtn.innerHTML = '<i class="fas fa-play"></i>';
  playBtn.onclick = () => {
    speakText(ex.audioText);
    playBtn.disabled = true;
    setTimeout(() => playBtn.disabled = false, 5000);
  };
  audioControls.appendChild(playBtn);
  content.appendChild(audioControls);
  
  const topicsContainer = document.createElement('div');
  topicsContainer.className = 'topics-container';
  ex.topics.forEach((topic, i) => {
    const card = document.createElement('div');
    card.className = 'topic-card';
    card.textContent = topic;
    if (userAnswers[currentExercise] !== null) card.classList.add('locked');
    card.onclick = () => handleTTSAnswer(i, ex.correct, ex);
    topicsContainer.appendChild(card);
  });
  content.appendChild(topicsContainer);
  
  const feedback = document.createElement('div');
  feedback.className = 'feedback';
  feedback.id = 'feedback';
  content.appendChild(feedback);
  
  exerciseScreen.appendChild(content);
}

// Handle TTS answer
function handleTTSAnswer(selected, correct, exercise) {
  if (userAnswers[currentExercise] !== null) return;
  
  userAnswers[currentExercise] = selected;
  if (selected === correct) {
    points += 10;
    document.getElementById('points').textContent = points;
  }
  
  document.querySelectorAll('.topic-card').forEach((card, i) => {
    card.classList.add('locked');
    if (i === selected) card.classList.add('selected');
    if (i === correct) card.classList.add('correct');
  });
  
  // Show transcript after answer
  const transcript = document.createElement('div');
  transcript.style.marginTop = '15px';
  transcript.style.fontStyle = 'italic';
  transcript.style.color = '#64748b';
  transcript.textContent = `"${exercise.audioText}"`;
  document.querySelector('.tts-exercise').appendChild(transcript);
  
  document.getElementById('feedback').textContent = exercise.explanation;
  document.getElementById('feedback').className = `feedback ${selected === correct ? 'correct' : 'incorrect'}`;
  
  document.querySelector('.btn-next').disabled = false;
  scrollToNextButton();
}

// Navigation and utilities
function addNavigation() {
  const nav = document.createElement('div');
  nav.className = 'navigation';
  
  const prev = document.createElement('button');
  prev.className = 'btn btn-prev';
  prev.textContent = 'Previous';
  prev.disabled = currentExercise === 0;
  prev.onclick = () => {
    if (currentExercise > 0) {
      currentExercise--;
      loadExercise(currentExercise);
      updateProgress();
    }
  };
  
  const next = document.createElement('button');
  next.className = 'btn btn-next';
  next.textContent = currentExercise === 4 ? 'Finish Topic' : 'Next';
  next.disabled = userAnswers[currentExercise] === null;
  next.onclick = () => {
    if (currentExercise < 4) {
      currentExercise++;
      loadExercise(currentExercise);
      updateProgress();
    } else {
      finishTopic();
    }
  };
  
  nav.appendChild(prev);
  nav.appendChild(next);
  exerciseScreen.appendChild(nav);
}

function updateProgress() {
  const percent = ((currentExercise + 1) / 5) * 100;
  document.getElementById('progress-fill').style.width = `${percent}%`;
  document.getElementById('progress-text').textContent = `${currentExercise + 1}/5`;
}

function scrollToNextButton() {
  setTimeout(() => {
    const btn = document.querySelector('.btn-next');
    if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 150);
}

function speakText(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'pl-PL';
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

function getTopicName(topic) {
  const names = {
    food: "Food & Dining",
    travel: "Travel & Directions",
    work: "Work & Office",
    daily: "Daily Life",
    shopping: "Shopping",
    health: "Health & Body",
    family: "Family & Friends",
    city: "Cities & Places",
    learning: "Learning Polish",
    media: "News & Media"
  };
  return names[topic] || topic;
}

function finishTopic() {
  exerciseScreen.classList.add('hidden');
  progressContainer.classList.add('hidden');
  completionScreen.classList.remove('hidden');
  
  let msg = "Keep practicing! üìö";
  if (points >= 45) msg = "Outstanding! üåü";
  else if (points >= 35) msg = "Great job! üëè";
  else if (points >= 25) msg = "Good effort! üí™";
  
  document.getElementById('completion-message').textContent = msg;
  document.getElementById('final-score').textContent = points; // ‚úÖ Only number
}

// Completion buttons
document.getElementById('new-topic-btn')?.addEventListener('click', () => {
  completionScreen.classList.add('hidden');
  if (currentMode === 'vocabulary') {
    modeSelectionScreen.classList.remove('hidden');
  } else {
    topicSelectionScreen.classList.remove('hidden');
  }
});
document.getElementById('restart-topic-btn')?.addEventListener('click', () => {
  if (currentMode === 'vocabulary') {
    startVocabularyPractice();
  } else {
    startTopicExercises(currentTopic);
  }
});
document.getElementById('change-level-btn')?.addEventListener('click', () => {
  completionScreen.classList.add('hidden');
  levelSelectionScreen.classList.remove('hidden');
});

// Init
renderLevelSelection();
</script>
</body>
</html>