<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PolskiCore â€“ Real Polish Comprehension</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* === EXACT SAME CSS AS BEFORE === */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
:root {
--primary: #7e22ce;
--secondary: #6b21a8;
--success: #4ade80;
--light-bg: #f8f9fa;
--dark-bg: #121826;
--card-light: #ffffff;
--card-dark: #1e293b;
--text-light: #212529;
--text-dark: #f1f5f9;
--shadow-light: rgba(0, 0, 0, 0.1);
--shadow-dark: rgba(0, 0, 0, 0.3);
--border-light: #dee2e6;
--border-dark: #334155;
--option-bg-light: white;
--option-bg-dark: #334155;
--correct: #4ade80;
--incorrect: #f87171;
--feedback-correct-light: #d1fae5;
--feedback-correct-dark: #064e3b;
--feedback-incorrect-light: #fee2e2;
--feedback-incorrect-dark: #7f1d1d;
--score-badge-bg: #fbbf24;
--score-badge-text: #1e293b;
}
body {
background: var(--bg);
color: var(--text);
min-height: 100vh;
padding: 20px;
transition: background-color 0.3s, color 0.3s;
}
.container {
max-width: 900px;
margin: 0 auto;
}
header {
text-align: center;
padding: 20px 0;
margin-bottom: 30px;
display: flex;
justify-content: space-between;
align-items: center;
}
.logo-container {
text-align: center;
flex: 1;
}
h1 {
font-size: 2.5rem;
color: var(--primary);
margin-bottom: 10px;
text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.subtitle {
color: var(--secondary);
font-size: 1.1rem;
max-width: 600px;
margin: 0 auto;
}
.theme-toggle {
background: var(--card);
border: 1px solid var(--border);
width: 50px;
height: 50px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 2px 6px var(--shadow);
transition: all 0.3s;
}
.theme-toggle:hover {
transform: rotate(20deg);
}
.progress-container {
background: var(--card);
border-radius: 12px;
padding: 20px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
border: 1px solid var(--border);
}
.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
font-weight: 600;
color: var(--secondary);
}
.progress-bar {
height: 12px;
background: var(--option-bg);
border-radius: 6px;
overflow: hidden;
border: 1px solid var(--border);
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--primary), var(--success));
border-radius: 6px;
width: 0%;
transition: width 0.5s ease;
}
.points-display {
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
margin-top: 15px;
font-size: 1.2rem;
font-weight: 700;
color: var(--warning);
}
.exercise-container {
background: var(--card);
border-radius: 12px;
padding: 30px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
min-height: 300px;
display: flex;
flex-direction: column;
border: 1px solid var(--border);
}
.exercise-title {
font-size: 1.5rem;
margin-bottom: 20px;
color: var(--secondary);
display: flex;
align-items: center;
gap: 10px;
justify-content: space-between;
}
.topic-name {
font-weight: 600;
color: var(--primary);
}
.back-btn {
background: none;
border: none;
color: var(--secondary);
font-weight: 600;
cursor: pointer;
display: flex;
align-items: center;
gap: 5px;
}
.back-btn:hover {
color: var(--primary);
}
.exercise-content {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
}
.missing-word-exercise {
text-align: center;
}
.sentence {
font-size: 1.4rem;
line-height: 1.6;
margin-bottom: 25px;
padding: 15px;
background: var(--bg-sentence);
border-radius: 8px;
border-left: 4px solid var(--primary);
}
.options-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 12px;
margin-top: 20px;
}
.option-btn {
padding: 12px 15px;
border: 2px solid var(--border);
border-radius: 8px;
background: var(--option-bg);
font-size: 1.1rem;
cursor: pointer;
transition: all 0.2s;
font-weight: 600;
color: var(--text);
}
.option-btn:hover:not(:disabled) {
border-color: var(--primary);
transform: translateY(-2px);
box-shadow: 0 4px 8px var(--shadow);
}
.option-btn:disabled {
opacity: 0.8;
cursor: not-allowed;
}
.option-btn.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.option-btn.correct {
background: var(--correct);
border-color: var(--correct);
color: white;
}
.option-btn.incorrect {
background: var(--incorrect);
border-color: var(--incorrect);
color: white;
}
.tts-exercise {
text-align: center;
}
.audio-controls {
display: flex;
justify-content: center;
gap: 15px;
margin: 25px 0;
}
.play-btn {
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--primary);
color: white;
border: none;
font-size: 1.5rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 4px 12px var(--shadow);
transition: all 0.2s;
}
.play-btn:hover {
background: var(--secondary);
transform: scale(1.05);
}
.play-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}
.topics-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 15px;
margin-top: 20px;
}
.topic-card {
padding: 20px;
border: 2px solid var(--border);
border-radius: 10px;
background: var(--option-bg);
cursor: pointer;
transition: all 0.2s;
text-align: center;
font-weight: 600;
color: var(--text);
}
.topic-card:hover:not(.selected):not(.locked) {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 4px 8px var(--shadow);
}
.topic-card.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.topic-card.locked {
opacity: 0.8;
cursor: not-allowed;
}
.feedback {
margin-top: 20px;
padding: 15px;
border-radius: 8px;
text-align: center;
font-weight: 600;
display: none;
}
.feedback.correct {
background: var(--feedback-correct);
color: var(--feedback-correct-text);
display: block;
}
.feedback.incorrect {
background: var(--feedback-incorrect);
color: var(--feedback-incorrect-text);
display: block;
}
.navigation {
display: flex;
justify-content: space-between;
margin-top: 20px;
}
.btn {
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.btn-prev {
background: var(--border);
color: var(--text);
}
.btn-prev:hover {
background: var(--primary);
color: white;
}
.btn-next {
background: var(--primary);
color: white;
}
.btn-next:hover {
background: var(--secondary);
}
.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}
.completion-screen, .topic-selection-screen, .level-selection-screen {
text-align: center;
padding: 40px 20px;
}
.completion-screen h2, .topic-selection-screen h2, .level-selection-screen h2 {
font-size: 2.2rem;
margin-bottom: 20px;
}
.final-score {
font-size: 1.8rem;
font-weight: 700;
color: var(--warning);
margin: 20px 0;
}
.action-buttons {
margin-top: 25px;
display: flex;
justify-content: center;
gap: 15px;
flex-wrap: wrap;
}
.restart-btn, .continue-btn, .new-topic-btn, .full-restart-btn {
background: var(--success);
color: white;
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.restart-btn:hover, .continue-btn:hover, .new-topic-btn:hover, .full-restart-btn:hover {
background: #3ab7e4;
transform: scale(1.03);
}
.topic-options {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 20px;
margin-top: 30px;
}
.topic-option {
padding: 25px 15px;
background: var(--card);
border: 2px solid var(--border);
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
font-weight: 600;
color: var(--text);
position: relative;
}
.topic-option:hover {
border-color: var(--primary);
transform: translateY(-5px);
box-shadow: 0 6px 12px var(--shadow);
}
.topic-option i {
display: block;
font-size: 2rem;
margin-bottom: 10px;
color: var(--primary);
}
.score-badge {
position: absolute;
top: 10px;
right: 10px;
background: var(--score-badge-bg);
color: var(--score-badge-text);
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.8rem;
font-weight: bold;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.hidden {
display: none;
}
@media (max-width: 600px) {
.exercise-container {
padding: 20px;
}
h1 {
font-size: 2rem;
}
.sentence {
font-size: 1.2rem;
}
.options-container, .topics-container, .topic-options {
grid-template-columns: 1fr;
}
header {
flex-direction: column;
gap: 15px;
}
.score-badge {
width: 24px;
height: 24px;
font-size: 0.7rem;
}
.action-buttons {
gap: 10px;
}
.restart-btn, .new-topic-btn {
padding: 10px 20px;
font-size: 1rem;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo-container">
<h1><i class="fas fa-language"></i> PolskiCore</h1>
<p class="subtitle">Master real Polish through high-frequency vocabulary in varied contexts.</p>
</div>
<div class="theme-toggle" id="theme-toggle">
<i class="fas fa-moon"></i>
</div>
</header>

<!-- LEVEL SELECTION SCREEN -->
<div class="level-selection-screen" id="level-selection-screen">
<h2>Select Your Comprehension Level</h2>
<p>Choose a vocabulary set optimized for real-world listening and reading.</p>
<div class="topic-options" id="level-options-container">
<!-- Filled by JS -->
</div>
</div>

<div class="progress-container hidden" id="progress-container">
<div class="progress-header">
<span>Progress</span>
<span id="progress-text">0/5</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
<div class="points-display">
<i class="fas fa-star"></i>
<span id="points">0</span> Points
</div>
</div>

<div class="exercise-container hidden" id="exercise-container">
<!-- Exercises loaded here -->
</div>

<div class="completion-screen hidden" id="completion-screen">
<h2 id="completion-message">Great Job! ðŸŒŸ</h2>
<p>You've completed the topic!</p>
<!-- âœ… FIXED SCORE DISPLAY -->
<div class="final-score">Your Score: <span id="final-score">0</span>/50 points</div>
<div class="action-buttons">
<button class="new-topic-btn" id="new-topic-btn">Choose Another Topic</button>
<button class="restart-btn" id="restart-topic-btn">Retry This Topic</button>
<button class="btn" style="background:#64748b; margin-top:10px;" id="change-level-btn">Change Level</button>
</div>
</div>

<div class="topic-selection-screen hidden" id="topic-selection-screen">
<h2>Choose a Topic to Practice</h2>
<p>Vocabulary comes from your selected level.</p>
<div class="topic-options" id="topic-options-container">
<!-- Filled by JS -->
</div>
</div>

<script>
// âœ… FOUR COMPREHENSION-OPTIMIZED LEVELS
const vocabLevels = {
  1: ["tak", "nie", "proszÄ™", "jest", "ma", "chce", "tu", "teraz", "no", "bardzo"],
  2: ["myÅ›lÄ™", "wiem", "rozumiem", "mÃ³wi", "ale", "bo", "wiÄ™c", "juÅ¼", "jeszcze", "moÅ¼e"],
  3: ["pewnie", "chyba", "poniewaÅ¼", "jednak", "mimo Å¼e", "gdyby", "waÅ¼ne", "trudno", "wÅ‚aÅ›nie", "raczej"],
  4: ["przecieÅ¼", "wÅ‚aÅ›ciwie", "oczywiÅ›cie", "niestety", "na szczÄ™Å›cie", "powinien", "mÃ³gÅ‚by", "trochÄ™", "serio?", "naprawdÄ™"]
};

// âœ… TOPIC TEMPLATES (context only)
const topicTemplates = {
  food: [
    {type:"missing-word",sentence:"PoproszÄ™ butelkÄ™ ___.",explanation:"'Wody' means water."},
    {type:"tts",audioText:"Zupa jest wyÅ›mienita! PoproszÄ™ rachunek.",topics:["Skargi","Chwalenie jedzenia","Pytanie o drogÄ™","Zamawianie ubraÅ„"],correct:1,explanation:"Praising soup and asking for bill."},
    {type:"missing-word",sentence:"Ile kosztuje to ___?",explanation:"'Menu' is used in restaurants."},
    {type:"tts",audioText:"Jestem wegetarianinem. Czy macie dania wegetariaÅ„skie?",topics:["Dieta","Alergie","Gotowanie w domu","Fast food"],correct:0,explanation:"Asking about vegetarian options."},
    {type:"missing-word",sentence:"ChciaÅ‚bym zamÃ³wiÄ‡ ___.",explanation:"'Piwo' means beer."}
  ],
  travel: [
    {type:"missing-word",sentence:"Gdzie jest najbliÅ¼szy ___?",explanation:"'Dworzec' means train station."},
    {type:"tts",audioText:"Przepraszam, jak dojÅ›Ä‡ do muzeum? Czy to daleko stÄ…d?",topics:["Pytanie o drogÄ™","Kupowanie biletÃ³w","Rezerwacja hotelu","Wynajem samochodu"],correct:0,explanation:"Asking for directions to the museum."},
    {type:"missing-word",sentence:"PotrzebujÄ™ ___ na trzy noce.",explanation:"'PokÃ³j' means room."},
    {type:"tts",audioText:"PociÄ…g do Krakowa odjeÅ¼dÅ¼a z peronu 3. ProszÄ™ siÄ™ pospieszyÄ‡!",topics:["OgÅ‚oszenia kolejowe","Informacje lotnicze","RozkÅ‚ady autobusÃ³w","TaksÃ³wki"],correct:0,explanation:"Train announcement."},
    {type:"missing-word",sentence:"Ile kosztuje bilet do ___?",explanation:"'Warszawy' is Warsaw in genitive case."}
  ],
  family: [
    {type:"missing-word",sentence:"To moja ___.",explanation:"'Siostra' means sister."},
    {type:"tts",audioText:"MÃ³j tata pracuje jako lekarz, a mama jest nauczycielkÄ….",topics:["Zawody","Hobby","Codzienne rutyny","CzÅ‚onkowie rodziny"],correct:3,explanation:"Talking about parents."},
    {type:"missing-word",sentence:"Masz ___?",explanation:"'RodzeÅ„stwo' means siblings."},
    {type:"tts",audioText:"Moje dziadkowie mieszkajÄ… w maÅ‚ej wsi na Mazurach.",topics:["CzÅ‚onkowie rodziny","Plany podrÃ³Å¼y","Mieszkanie","Pogoda"],correct:0,explanation:"Talking about grandparents."},
    {type:"missing-word",sentence:"Jutro Å›wiÄ™tujemy urodziny ___ .",explanation:"'Babci' means grandmother's."}
  ],
  shopping: [
    {type:"missing-word",sentence:"Ile to kosztuje ___?",explanation:"'Kurtka' means jacket."},
    {type:"tts",audioText:"Czy macie te buty w rozmiarze 40?",topics:["Pytanie o rozmiar","Zwrot towaru","Cena","Godziny otwarcia"],correct:0,explanation:"Asking for shoe size."},
    {type:"missing-word",sentence:"ChciaÅ‚bym ___ tÄ™ spodnie.",explanation:"'ZamieniÄ‡' means to exchange."},
    {type:"tts",audioText:"Kasa jest po lewej stronie sklepu.",topics:["Szukanie kasy","ZniÅ¼ki","DostÄ™pnoÅ›Ä‡ produktÃ³w","UkÅ‚ad sklepu"],correct:0,explanation:"Where the cashier is."},
    {type:"missing-word",sentence:"Czy jest tu ___?",explanation:"'ZniÅ¼ka' means discount."}
  ],
  hobbies: [
    {type:"missing-word",sentence:"Gram chÄ™tnie na ___.",explanation:"'Fortepianie' means piano (locative)."},
    {type:"tts",audioText:"W sobotÄ™ idÄ™ do kina, Å¼eby obejrzeÄ‡ nowy film Marvela.",topics:["Kino","Czytanie ksiÄ…Å¼ek","Sport","Gotowanie"],correct:0,explanation:"Going to the movies."},
    {type:"missing-word",sentence:"Moim hobby jest ___.",explanation:"'Fotografia' means photography."},
    {type:"tts",audioText:"Codziennie wieczorem czytam ksiÄ…Å¼kÄ™ przed snem.",topics:["Czytanie","Pisanie","Malarstwo","Taniec"],correct:0,explanation:"Reading before bed."},
    {type:"missing-word",sentence:"W weekend czÄ™sto chodzÄ™ ___.",explanation:"'Na wycieczki' means hiking/trips."}
  ],
  work: [
    {type:"missing-word",sentence:"Mam waÅ¼ne ___ z szefem.",explanation:"'Spotkanie' means meeting."},
    {type:"tts",audioText:"Czy mÃ³gÅ‚byÅ› przesÅ‚aÄ‡ mi tÄ™ prezentacjÄ™ mailem?",topics:["ProÅ›by","Skargi","Plotki","Rozkazy"],correct:0,explanation:"Polite request for presentation via email."},
    {type:"missing-word",sentence:"MÃ³j ___ jest dziÅ› bardzo zajÄ™ty.",explanation:"'Kolega' means colleague."},
    {type:"tts",audioText:"Firma rekrutuje nowych pracownikÃ³w do dziaÅ‚u marketingu.",topics:["Praca","WiadomoÅ›ci firmowe","Plotki","Skargi"],correct:0,explanation:"Job opening in marketing."},
    {type:"missing-word",sentence:"MuszÄ™ napisaÄ‡ ___.",explanation:"'Raport' means report."}
  ],
  health: [
    {type:"missing-word",sentence:"MÃ³j ___ boli.",explanation:"'GÅ‚owa' means head."},
    {type:"tts",audioText:"Mam silny bÃ³l brzucha i mdÅ‚oÅ›ci.",topics:["Objawy","Plany","Jedzenie","Pogoda"],correct:0,explanation:"Describing illness symptoms."},
    {type:"missing-word",sentence:"WeÅº ___ tabletki trzy razy dziennie.",explanation:"'Te' is plural demonstrative for 'tabletki'."},
    {type:"tts",audioText:"PowinieneÅ› piÄ‡ wiÄ™cej wody i mniej kawy.",topics:["WskazÃ³wki","Sen","Ä†wiczenia","Leki"],correct:0,explanation:"Hydration advice."},
    {type:"missing-word",sentence:"IdÄ™ na ___ do dentysty.",explanation:"'WizytÄ™' means appointment."}
  ],
  school: [
    {type:"missing-word",sentence:"Lekcje zaczynajÄ… siÄ™ o ___.",explanation:"'Ã“smej' means eight o'clock (locative case)."},
    {type:"tts",audioText:"MuszÄ™ nauczyÄ‡ siÄ™ na jutrzejszy test z historii.",topics:["Przygotowanie do testu","Skargi na zadanie domowe","PochwaÅ‚a nauczyciela","Zasady w klasie"],correct:0,explanation:"Talking about exam preparation."},
    {type:"missing-word",sentence:"DostaÅ‚em dobrÄ… ___ z matematyki.",explanation:"'OcenÄ™' means grade/mark."},
    {type:"tts",audioText:"Na przerwie gramy w piÅ‚kÄ™ na boisku.",topics:["AktywnoÅ›Ä‡ na przerwie","Lekcje w klasie","Zadanie domowe","KÃ³Å‚ka pozalekcyjne"],correct:0,explanation:"Describes recess activities."},
    {type:"missing-word",sentence:"MÃ³j ___ pomaga mi z pracami domowymi.",explanation:"'Nauczyciel' means teacher."}
  ],
  cities: [
    {type:"missing-word",sentence:"Warszawa jest ___ Polski.",explanation:"'StolicÄ…' means capital city."},
    {type:"tts",audioText:"W Krakowie jest wiele zabytkÃ³w i piÄ™kny Rynek GÅ‚Ã³wny.",topics:["Atrakcje miejskie","PorÃ³wnania krajÃ³w","Å»ycie na wsi","System transportu"],correct:0,explanation:"Describes attractions in KrakÃ³w."},
    {type:"missing-word",sentence:"To ___ jest bardzo stare.",explanation:"'Zamek' means castle."},
    {type:"tts",audioText:"Stare Miasto w GdaÅ„sku jest znane z piÄ™knej architektury.",topics:["Historyczne dzielnice","Nowoczesna architektura","Obszary przemysÅ‚owe","Å»ycie podmiejskie"],correct:0,explanation:"Describes GdaÅ„sk's historic old town."},
    {type:"missing-word",sentence:"OdwiedzÄ™ ___ w weekend.",explanation:"'Muzeum' means museum."}
  ],
  animals: [
    {type:"missing-word",sentence:"___ szczeka gÅ‚oÅ›no.",explanation:"'Pies' means dog."},
    {type:"tts",audioText:"W lesie moÅ¼na spotkaÄ‡ jelenie, lisy i wiewiÃ³rki.",topics:["Å»ycie miejskie","ZwierzÄ™ta leÅ›ne","Stworzenia morskie","ZwierzÄ™ta farmy"],correct:1,explanation:"Describes forest animals."},
    {type:"missing-word",sentence:"___ fruwa wysoko w niebie.",explanation:"'Ptak' means bird."},
    {type:"tts",audioText:"WiosnÄ… kwitnÄ… kwiaty, a drzewa zyskujÄ… nowe liÅ›cie.",topics:["Pory roku","Pogoda","OgrÃ³dnictwo","Cykle przyrody"],correct:3,explanation:"Describes natural cycles in spring."},
    {type:"missing-word",sentence:"WidzÄ™ ___ w zoo.",explanation:"'Lwa' means lion."}
  ]
};

// DOM elements
const levelSelectionScreen = document.getElementById('level-selection-screen');
const topicSelectionScreen = document.getElementById('topic-selection-screen');
const exerciseScreen = document.getElementById('exercise-container');
const progressContainer = document.getElementById('progress-container');
const completionScreen = document.getElementById('completion-screen');
const levelOptionsContainer = document.getElementById('level-options-container');
const topicOptionsContainer = document.getElementById('topic-options-container');
const themeToggle = document.getElementById('theme-toggle');

let currentLevel = 1;
let currentTopic = null;
let exercises = [];
let currentExercise = 0;
let points = 0;
let userAnswers = [];
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// Apply theme
applyTheme();
themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
themeToggle.addEventListener('click', () => {
  isDarkMode = !isDarkMode;
  localStorage.setItem('darkMode', isDarkMode);
  applyTheme();
  themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

function applyTheme() {
  const root = document.documentElement;
  if (isDarkMode) {
    root.style.setProperty('--bg', 'var(--dark-bg)');
    root.style.setProperty('--text', 'var(--text-dark)');
    root.style.setProperty('--card', 'var(--card-dark)');
    root.style.setProperty('--border', 'var(--border-dark)');
    root.style.setProperty('--option-bg', 'var(--option-bg-dark)');
    root.style.setProperty('--bg-sentence', 'rgba(30, 41, 59, 0.7)');
    root.style.setProperty('--shadow', 'var(--shadow-dark)');
    root.style.setProperty('--feedback-correct', 'var(--feedback-correct-dark)');
    root.style.setProperty('--feedback-correct-text', 'white');
    root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-dark)');
    root.style.setProperty('--feedback-incorrect-text', 'white');
    root.style.setProperty('--warning', '#fbbf24');
  } else {
    root.style.setProperty('--bg', 'var(--light-bg)');
    root.style.setProperty('--text', 'var(--text-light)');
    root.style.setProperty('--card', 'var(--card-light)');
    root.style.setProperty('--border', 'var(--border-light)');
    root.style.setProperty('--option-bg', 'var(--option-bg-light)');
    root.style.setProperty('--bg-sentence', '#f1f5ff');
    root.style.setProperty('--shadow', 'var(--shadow-light)');
    root.style.setProperty('--feedback-correct', 'var(--feedback-correct-light)');
    root.style.setProperty('--feedback-correct-text', 'var(--text-light)');
    root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-light)');
    root.style.setProperty('--feedback-incorrect-text', 'var(--text-light)');
    root.style.setProperty('--warning', '#f8961e');
  }
}

// Render level selection
function renderLevelSelection() {
  levelOptionsContainer.innerHTML = '';
  const levels = [
    {num: 1, name: "Core Survival & Spoken Glue"},
    {num: 2, name: "High-Frequency Expansion"},
    {num: 3, name: "Precision & Structural Control"},
    {num: 4, name: "Pragmatic & Nuance Control"}
  ];
  
  levels.forEach(level => {
    const el = document.createElement('div');
    el.className = 'topic-option';
    el.innerHTML = `<i class="fas fa-layer-group"></i> Level ${level.num}<br><small>${level.name}</small>`;
    el.onclick = () => {
      currentLevel = level.num;
      levelSelectionScreen.classList.add('hidden');
      renderTopicSelection();
      topicSelectionScreen.classList.remove('hidden');
    };
    levelOptionsContainer.appendChild(el);
  });
}

// Render topic selection
function renderTopicSelection() {
  topicOptionsContainer.innerHTML = '';
  Object.keys(topicTemplates).forEach(topicKey => {
    const topic = topicTemplates[topicKey];
    const topicOption = document.createElement('div');
    topicOption.className = 'topic-option';
    topicOption.innerHTML = `<i class="fas fa-${getTopicIcon(topicKey)}"></i>${getTopicName(topicKey)}`;
    topicOption.onclick = () => startTopicExercises(topicKey);
    topicOptionsContainer.appendChild(topicOption);
  });
}

function getTopicIcon(topic) {
  const icons = {
    food: "utensils",
    travel: "plane",
    family: "users",
    shopping: "shopping-bag",
    hobbies: "film",
    work: "briefcase",
    health: "heartbeat",
    school: "graduation-cap",
    cities: "city",
    animals: "paw"
  };
  return icons[topic] || "question";
}

function getTopicName(topic) {
  const names = {
    food: "Food & Dining",
    travel: "Travel & Directions",
    family: "Family & Friends",
    shopping: "Shopping",
    hobbies: "Hobbies & Leisure",
    work: "Work & Office",
    health: "Health & Body",
    school: "School & Education",
    cities: "Cities & Places",
    animals: "Animals & Nature"
  };
  return names[topic] || topic;
}

// Start topic exercises
function startTopicExercises(topicKey) {
  topicSelectionScreen.classList.add('hidden');
  progressContainer.classList.remove('hidden');
  exerciseScreen.classList.remove('hidden');
  completionScreen.classList.add('hidden');
  
  currentTopic = topicKey;
  currentExercise = 0;
  points = 0;
  userAnswers = new Array(5).fill(null);
  
  // Generate exercises using selected level's vocabulary
  exercises = generateExercises(topicKey, currentLevel);
  
  document.getElementById('points').textContent = points;
  updateProgress();
  loadExercise(currentExercise);
}

function generateExercises(topicKey, level) {
  const templates = topicTemplates[topicKey];
  const vocab = vocabLevels[level];
  const result = [];
  
  for (let i = 0; i < 5; i++) {
    const template = templates[i];
    if (template.type === 'missing-word') {
      // Inject vocab word as correct answer
      const correctWord = vocab[i % vocab.length];
      
      // Create plausible distractors from same level
      let distractors = vocab.filter(w => w !== correctWord).slice(0, 3);
      while (distractors.length < 3) {
        distractors.push(vocab[Math.floor(Math.random() * vocab.length)]);
      }
      
      const options = [correctWord, ...distractors].sort(() => Math.random() - 0.5);
      const correctIndex = options.indexOf(correctWord);
      
      result.push({
        type: 'missing-word',
        sentence: template.sentence.replace("___", "________"),
        options,
        correct: correctIndex,
        explanation: `"${correctWord}" is a high-frequency word. ${template.explanation}`
      });
    } else {
      // TTS exercises remain unchanged
      result.push({...template});
    }
  }
  
  return result;
}

// Load exercise (identical to before)
function loadExercise(index) {
  const ex = exercises[index];
  exerciseScreen.innerHTML = '';
  
  const title = document.createElement('div');
  title.className = 'exercise-title';
  title.innerHTML = `
    <span><i class="fas fa-${ex.type === 'missing-word' ? 'puzzle-piece' : 'headphones'}"></i> ${ex.type === 'missing-word' ? 'Fill in the Blank' : 'Listen & Identify Topic'}</span>
    <div>
      <span class="topic-name">${getTopicName(currentTopic)}</span>
      <button class="back-btn" id="back-to-topics-btn">
        <i class="fas fa-arrow-left"></i> Topics
      </button>
    </div>
  `;
  exerciseScreen.appendChild(title);
  
  setTimeout(() => {
    const backBtn = document.getElementById('back-to-topics-btn');
    if (backBtn) backBtn.onclick = () => {
      exerciseScreen.classList.add('hidden');
      progressContainer.classList.add('hidden');
      topicSelectionScreen.classList.remove('hidden');
    };
  }, 0);
  
  if (ex.type === 'missing-word') {
    renderMissingWordExercise(ex);
  } else {
    renderTTsExercise(ex);
  }
  
  addNavigation();
}

// Render missing word exercise
function renderMissingWordExercise(ex) {
  const content = document.createElement('div');
  content.className = 'exercise-content missing-word-exercise';
  
  const sentenceEl = document.createElement('div');
  sentenceEl.className = 'sentence';
  sentenceEl.textContent = ex.sentence;
  content.appendChild(sentenceEl);
  
  const optionsContainer = document.createElement('div');
  optionsContainer.className = 'options-container';
  ex.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    if (userAnswers[currentExercise] !== null) btn.disabled = true;
    btn.onclick = () => handleMissingWordAnswer(i, ex.correct, ex);
    optionsContainer.appendChild(btn);
  });
  content.appendChild(optionsContainer);
  
  const feedback = document.createElement('div');
  feedback.className = 'feedback';
  feedback.id = 'feedback';
  content.appendChild(feedback);
  
  exerciseScreen.appendChild(content);
}

// Handle missing word answer
function handleMissingWordAnswer(selected, correct, exercise) {
  userAnswers[currentExercise] = selected;
  if (selected === correct) {
    points += 10;
    document.getElementById('points').textContent = points;
  }
  
  document.querySelectorAll('.option-btn').forEach((btn, i) => {
    btn.disabled = true;
    if (i === selected) btn.classList.add(selected === correct ? 'correct' : 'incorrect');
    else if (i === correct) btn.classList.add('correct');
  });
  
  document.getElementById('feedback').textContent = exercise.explanation;
  document.getElementById('feedback').className = `feedback ${selected === correct ? 'correct' : 'incorrect'}`;
  
  // Speak correct sentence
  const fullSentence = exercise.sentence.replace("________", exercise.options[exercise.correct]);
  speakText(fullSentence);
  
  document.querySelector('.btn-next').disabled = false;
  scrollToNextButton();
}

// Render TTS exercise
function renderTTsExercise(ex) {
  const content = document.createElement('div');
  content.className = 'exercise-content tts-exercise';
  
  const instruction = document.createElement('p');
  instruction.textContent = 'Listen to the Polish sentence and select the correct topic:';
  instruction.style.marginBottom = '20px';
  instruction.style.fontSize = '1.1rem';
  content.appendChild(instruction);
  
  const audioControls = document.createElement('div');
  audioControls.className = 'audio-controls';
  const playBtn = document.createElement('button');
  playBtn.className = 'play-btn';
  playBtn.innerHTML = '<i class="fas fa-play"></i>';
  playBtn.onclick = () => {
    speakText(ex.audioText);
    playBtn.disabled = true;
    setTimeout(() => playBtn.disabled = false, 5000);
  };
  audioControls.appendChild(playBtn);
  content.appendChild(audioControls);
  
  const topicsContainer = document.createElement('div');
  topicsContainer.className = 'topics-container';
  ex.topics.forEach((topic, i) => {
    const card = document.createElement('div');
    card.className = 'topic-card';
    card.textContent = topic;
    if (userAnswers[currentExercise] !== null) card.classList.add('locked');
    card.onclick = () => handleTTSAnswer(i, ex.correct, ex);
    topicsContainer.appendChild(card);
  });
  content.appendChild(topicsContainer);
  
  const feedback = document.createElement('div');
  feedback.className = 'feedback';
  feedback.id = 'feedback';
  content.appendChild(feedback);
  
  exerciseScreen.appendChild(content);
}

// Handle TTS answer
function handleTTSAnswer(selected, correct, exercise) {
  if (userAnswers[currentExercise] !== null) return;
  
  userAnswers[currentExercise] = selected;
  if (selected === correct) {
    points += 10;
    document.getElementById('points').textContent = points;
  }
  
  document.querySelectorAll('.topic-card').forEach((card, i) => {
    card.classList.add('locked');
    if (i === selected) card.classList.add('selected');
    if (i === correct) card.classList.add('correct');
  });
  
  // Show transcript after answer
  const transcript = document.createElement('div');
  transcript.style.marginTop = '15px';
  transcript.style.fontStyle = 'italic';
  transcript.style.color = '#64748b';
  transcript.textContent = `"${exercise.audioText}"`;
  document.querySelector('.tts-exercise').appendChild(transcript);
  
  document.getElementById('feedback').textContent = exercise.explanation;
  document.getElementById('feedback').className = `feedback ${selected === correct ? 'correct' : 'incorrect'}`;
  
  document.querySelector('.btn-next').disabled = false;
  scrollToNextButton();
}

// Navigation and utilities (same as before)
function addNavigation() {
  const nav = document.createElement('div');
  nav.className = 'navigation';
  
  const prev = document.createElement('button');
  prev.className = 'btn btn-prev';
  prev.textContent = 'Previous';
  prev.disabled = currentExercise === 0;
  prev.onclick = () => {
    if (currentExercise > 0) {
      currentExercise--;
      loadExercise(currentExercise);
      updateProgress();
    }
  };
  
  const next = document.createElement('button');
  next.className = 'btn btn-next';
  next.textContent = currentExercise === 4 ? 'Finish Topic' : 'Next';
  next.disabled = userAnswers[currentExercise] === null;
  next.onclick = () => {
    if (currentExercise < 4) {
      currentExercise++;
      loadExercise(currentExercise);
      updateProgress();
    } else {
      finishTopic();
    }
  };
  
  nav.appendChild(prev);
  nav.appendChild(next);
  exerciseScreen.appendChild(nav);
}

function updateProgress() {
  const percent = ((currentExercise + 1) / 5) * 100;
  document.getElementById('progress-fill').style.width = `${percent}%`;
  document.getElementById('progress-text').textContent = `${currentExercise + 1}/5`;
}

function scrollToNextButton() {
  setTimeout(() => {
    const btn = document.querySelector('.btn-next');
    if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 150);
}

function speakText(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'pl-PL';
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

function finishTopic() {
  exerciseScreen.classList.add('hidden');
  progressContainer.classList.add('hidden');
  completionScreen.classList.remove('hidden');
  
  let msg = "Keep practicing! ðŸ“š";
  if (points >= 45) msg = "Outstanding! ðŸŒŸ";
  else if (points >= 35) msg = "Great job! ðŸ‘";
  else if (points >= 25) msg = "Good effort! ðŸ’ª";
  
  document.getElementById('completion-message').textContent = msg;
  document.getElementById('final-score').textContent = points; // âœ… Only number
}

// Completion buttons
document.getElementById('new-topic-btn')?.addEventListener('click', () => {
  completionScreen.classList.add('hidden');
  topicSelectionScreen.classList.remove('hidden');
});
document.getElementById('restart-topic-btn')?.addEventListener('click', () => {
  startTopicExercises(currentTopic);
});
document.getElementById('change-level-btn')?.addEventListener('click', () => {
  completionScreen.classList.add('hidden');
  levelSelectionScreen.classList.remove('hidden');
});

// Init
renderLevelSelection();
</script>
</body>
</html>