<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teraz Polski - Learn Polish Language</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
:root {
--primary: #4361ee;
--secondary: #3f37c9;
--success: #4cc9f0;
--light-bg: #f8f9fa;
--dark-bg: #121826;
--card-light: #ffffff;
--card-dark: #1e293b;
--text-light: #212529;
--text-dark: #f1f5f9;
--subheading-light: #4a5568;
--subheading-dark: #cbd5e1;
--shadow-light: rgba(0, 0, 0, 0.1);
--shadow-dark: rgba(0, 0, 0, 0.3);
--border-light: #dee2e6;
--border-dark: #334155;
--option-bg-light: white;
--option-bg-dark: #334155;
--correct: #4ade80;
--incorrect: #f87171;
--feedback-correct-light: #d1fae5;
--feedback-correct-dark: #064e3b;
--feedback-incorrect-light: #fee2e2;
--feedback-incorrect-dark: #7f1d1d;
--score-badge-bg: #fbbf24;
--score-badge-text: #1e293b;
}
body {
background: var(--bg);
color: var(--text);
min-height: 100vh;
padding: 20px;
transition: background-color 0.3s, color 0.3s;
}
.container {
max-width: 900px;
margin: 0 auto;
}
header {
text-align: center;
padding: 20px 0;
margin-bottom: 30px;
display: flex;
justify-content: space-between;
align-items: center;
}
.logo-container {
text-align: center;
flex: 1;
}
h1 {
font-size: 2.5rem;
color: var(--primary);
margin-bottom: 10px;
text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.subtitle {
color: var(--subheading);
font-size: 1.1rem;
max-width: 600px;
margin: 0 auto;
}
.theme-toggle {
background: var(--card);
border: 1px solid var(--border);
width: 50px;
height: 50px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 2px 6px var(--shadow);
transition: all 0.3s;
}
.theme-toggle:hover {
transform: rotate(20deg);
}
.progress-container {
background: var(--card);
border-radius: 12px;
padding: 20px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
border: 1px solid var(--border);
}
.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
font-weight: 600;
color: var(--secondary);
}
.progress-bar {
height: 12px;
background: var(--option-bg);
border-radius: 6px;
overflow: hidden;
border: 1px solid var(--border);
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--primary), var(--success));
border-radius: 6px;
width: 0%;
transition: width 0.5s ease;
}
.points-display {
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
margin-top: 15px;
font-size: 1.2rem;
font-weight: 700;
color: var(--warning);
}
.exercise-container {
background: var(--card);
border-radius: 12px;
padding: 30px;
box-shadow: 0 4px 12px var(--shadow);
margin-bottom: 30px;
min-height: 300px;
display: flex;
flex-direction: column;
border: 1px solid var(--border);
}
.exercise-title {
font-size: 1.5rem;
margin-bottom: 20px;
color: var(--secondary);
display: flex;
align-items: center;
gap: 10px;
justify-content: space-between;
}
.topic-name {
font-weight: 600;
color: var(--primary);
}
.back-btn {
background: none;
border: none;
color: var(--secondary);
font-weight: 600;
cursor: pointer;
display: flex;
align-items: center;
gap: 5px;
}
.back-btn:hover {
color: var(--primary);
}
.exercise-content {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
}
.missing-word-exercise {
text-align: center;
}
.sentence {
font-size: 1.4rem;
line-height: 1.6;
margin-bottom: 25px;
padding: 15px;
background: var(--bg-sentence);
border-radius: 8px;
border-left: 4px solid var(--primary);
}
.options-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 12px;
margin-top: 20px;
}
.option-btn {
padding: 12px 15px;
border: 2px solid var(--border);
border-radius: 8px;
background: var(--option-bg);
font-size: 1.1rem;
cursor: pointer;
transition: all 0.2s;
font-weight: 600;
color: var(--text);
}
.option-btn:hover:not(:disabled) {
border-color: var(--primary);
transform: translateY(-2px);
box-shadow: 0 4px 8px var(--shadow);
}
.option-btn:disabled {
opacity: 0.8;
cursor: not-allowed;
}
.option-btn.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.option-btn.correct {
background: var(--correct);
border-color: var(--correct);
color: white;
}
.option-btn.incorrect {
background: var(--incorrect);
border-color: var(--incorrect);
color: white;
}
.tts-exercise {
text-align: center;
}
.audio-controls {
display: flex;
justify-content: center;
gap: 15px;
margin: 25px 0;
}
.play-btn {
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--primary);
color: white;
border: none;
font-size: 1.5rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 4px 12px var(--shadow);
transition: all 0.2s;
}
.play-btn:hover {
background: var(--secondary);
transform: scale(1.05);
}
.play-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}
.topics-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 15px;
margin-top: 20px;
}
.topic-card {
padding: 20px;
border: 2px solid var(--border);
border-radius: 10px;
background: var(--option-bg);
cursor: pointer;
transition: all 0.2s;
text-align: center;
font-weight: 600;
color: var(--text);
}
.topic-card:hover:not(.selected):not(.locked) {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 4px 8px var(--shadow);
}
.topic-card.selected {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.topic-card.locked {
opacity: 0.8;
cursor: not-allowed;
}
.feedback {
margin-top: 20px;
padding: 15px;
border-radius: 8px;
text-align: center;
font-weight: 600;
display: none;
}
.feedback.correct {
background: var(--feedback-correct);
color: var(--feedback-correct-text);
display: block;
}
.feedback.incorrect {
background: var(--feedback-incorrect);
color: var(--feedback-incorrect-text);
display: block;
}
.navigation {
display: flex;
justify-content: space-between;
margin-top: 20px;
}
.btn {
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.btn-prev {
background: var(--border);
color: var(--text);
}
.btn-prev:hover {
background: var(--primary);
color: white;
}
.btn-next {
background: var(--primary);
color: white;
}
.btn-next:hover {
background: var(--secondary);
}
.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}
.completion-screen, .topic-selection-screen, .level-selection {
text-align: center;
padding: 40px 20px;
}
.completion-screen h2, .topic-selection-screen h2, .level-selection h2 {
font-size: 2.2rem;
margin-bottom: 20px;
color: var(--text);
}
.completion-screen p, .topic-selection-screen p, .level-selection p {
color: var(--subheading);
font-size: 1.1rem;
margin-bottom: 10px;
}
.final-score {
font-size: 1.8rem;
font-weight: 700;
color: var(--warning);
margin: 20px 0;
}
.action-buttons {
margin-top: 25px;
display: flex;
justify-content: center;
gap: 15px;
flex-wrap: wrap;
}
.restart-btn, .continue-btn, .new-topic-btn, .full-restart-btn {
background: var(--success);
color: white;
padding: 12px 25px;
border: none;
border-radius: 8px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.restart-btn:hover, .continue-btn:hover, .new-topic-btn:hover, .full-restart-btn:hover {
background: #3ab7e4;
transform: scale(1.03);
}
.topic-options {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 20px;
margin-top: 30px;
}
.topic-option {
padding: 25px 15px;
background: var(--card);
border: 2px solid var(--border);
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
font-weight: 600;
color: var(--text);
position: relative;
}
.topic-option:hover {
border-color: var(--primary);
transform: translateY(-5px);
box-shadow: 0 6px 12px var(--shadow);
}
.topic-option i {
display: block;
font-size: 2rem;
margin-bottom: 10px;
color: var(--primary);
}
.score-badge {
position: absolute;
top: 10px;
right: 10px;
background: var(--score-badge-bg);
color: var(--score-badge-text);
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.8rem;
font-weight: bold;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.level-selection {
text-align: center;
margin-bottom: 30px;
}
.level-selector {
padding: 12px 20px;
border-radius: 8px;
border: 2px solid var(--border);
background: var(--card);
color: var(--text);
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
min-width: 300px;
margin-top: 10px;
}
.level-description {
margin-top: 10px;
color: var(--subheading);
font-size: 0.95rem;
max-width: 500px;
margin-left: auto;
margin-right: auto;
line-height: 1.5;
}
.level-badge {
display: inline-block;
padding: 4px 10px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: bold;
margin-left: 8px;
background: var(--primary);
color: white;
}
.hidden {
display: none;
}
@media (max-width: 600px) {
.exercise-container {
padding: 20px;
}
h1 {
font-size: 2rem;
}
.sentence {
font-size: 1.2rem;
}
.options-container, .topics-container, .topic-options {
grid-template-columns: 1fr;
}
header {
flex-direction: column;
gap: 15px;
}
.score-badge {
width: 24px;
height: 24px;
font-size: 0.7rem;
}
.action-buttons {
gap: 10px;
}
.restart-btn, .new-topic-btn {
padding: 10px 20px;
font-size: 1rem;
}
.level-selector {
min-width: 250px;
}
.completion-screen h2, .topic-selection-screen h2, .level-selection h2 {
font-size: 1.8rem;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo-container">
<h1><i class="fas fa-language"></i> Teraz Polski</h1>
<p class="subtitle">Learn Polish through interactive exercises. Perfect for beginners and intermediate learners!</p>
</div>
<div class="theme-toggle" id="theme-toggle">
<i class="fas fa-moon"></i>
</div>
</header>

<div class="level-selection" id="level-selection-screen">
<h2>Select Your Vocabulary Level</h2>
<p>Choose a level to focus on specific vocabulary sets:</p>
<select class="level-selector" id="level-selector">
<option value="1">Level 1: Foundation (Most Essential 300 Words)</option>
<option value="2">Level 2: Elementary (+300 Common Words)</option>
<option value="3" selected>Level 3: Intermediate (+300 Useful Words)</option>
<option value="4">Level 4: Advanced (+300 Practical Words)</option>
</select>
<div class="level-description" id="level-description">
Builds core vocabulary for everyday conversations. Focus on high-frequency verbs, nouns, and essential phrases.
</div>
<button class="btn btn-next" id="proceed-to-topics-btn" style="margin-top: 25px; width: 200px;">
Proceed to Topics <i class="fas fa-arrow-right"></i>
</button>
</div>

<div class="progress-container hidden" id="progress-container">
<div class="progress-header">
<span>Progress</span>
<span id="progress-text">0/5</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
<div class="points-display">
<i class="fas fa-star"></i>
<span id="points">0</span> Points
</div>
</div>

<div class="exercise-container hidden" id="exercise-container">
<!-- Exercises will be loaded here -->
</div>

<div class="completion-screen hidden" id="completion-screen">
<h2 id="completion-message">Great Job! ðŸŒŸ</h2>
<p>You've completed the topic!</p>
<div class="final-score">Your Score: <span id="final-score">0</span>/50 points</div>
<div class="action-buttons">
<button class="new-topic-btn" id="new-topic-btn">Choose Another Topic</button>
<button class="restart-btn" id="restart-topic-btn">Retry This Topic</button>
</div>
</div>

<div class="topic-selection-screen hidden" id="topic-selection-screen">
<h2>Choose a Topic to Practice <span class="level-badge" id="current-level-badge">Level 3</span></h2>
<p>Select any topic to practice Polish vocabulary from your chosen level!</p>
<div class="topic-options" id="topic-options-container">
<!-- Topics will be populated here -->
</div>
<button class="back-btn" id="back-to-levels-btn" style="margin-top: 30px;">
<i class="fas fa-arrow-left"></i> Change Vocabulary Level
</button>
</div>
</div>

<script>
// ==================== VOCABULARY LEVELS ====================
const VOCABULARY_LEVELS = {
  1: {
    name: "Foundation",
    description: "Most essential 300 words for basic communication. Focus on high-frequency verbs, nouns, and essential phrases.",
    wordCount: 300
  },
  2: {
    name: "Elementary", 
    description: "Additional 300 common words for everyday situations. Expands vocabulary for practical conversations.",
    wordCount: 600
  },
  3: {
    name: "Intermediate",
    description: "300 useful words for more complex expressions. Includes abstract concepts and nuanced vocabulary.",
    wordCount: 900
  },
  4: {
    name: "Advanced",
    description: "300 practical words for fluent communication. Covers specialized topics and idiomatic expressions.",
    wordCount: 1200
  }
};

// ==================== ALL TOPICS WITH LEVEL TAGS ====================
const allTopics = {
food: {
  name: "Food & Dining",
  icon: "fa-utensils",
  sets: [
    [
      {type:"missing-word", sentence:"PoproszÄ™ butelkÄ™ ___.", options:["wody","domu","samochodu","krzesÅ‚a"], correct:0, explanation:"'Wody' means water - a common drink order in Polish.", level:1},
      {type:"tts", audioText:"Zupa jest wyÅ›mienita! Czy moÅ¼emy poprosiÄ‡ o rachunek?", topics:["Complaining","Praising food","Asking for directions","Ordering clothes"], correct:1, explanation:"The speaker is praising the soup and asking for the bill in Polish.", level:2},
      {type:"missing-word", sentence:"Ile kosztuje ___?", options:["menu","ksiÄ™Å¼yc","mysz","czapka"], correct:0, explanation:"'Menu' means menu in Polish restaurant context.", level:1},
      {type:"tts", audioText:"Jestem wegetarianinem. Czy macie dania wegetariaÅ„skie?", topics:["Dietary needs","Allergies","Cooking at home","Fast food"], correct:0, explanation:"The speaker is asking about vegetarian options in Polish.", level:3},
      {type:"missing-word", sentence:"ChciaÅ‚bym zamÃ³wiÄ‡ ___.", options:["piwo","ksiÄ…Å¼kÄ™","Å‚Ã³Å¼ko","Å‚odÅº"], correct:0, explanation:"'Piwo' means beer - a common order in Poland.", level:1}
    ],
    [
      {type:"missing-word", sentence:"Czy mogÄ™ prosiÄ‡ o ___?", options:["kartÄ™ daÅ„","noÅ¼yczki","wÄ™Å¼a","miskÄ™"], correct:0, explanation:"'KartÄ™ daÅ„' means menu card in Polish.", level:2},
      {type:"tts", audioText:"PoproszÄ™ stek woÅ‚owy Å›rednio wysmaÅ¼ony.", topics:["Ordering meat","Asking for drinks","Requesting dessert","Complaining about service"], correct:0, explanation:"The speaker is ordering a medium-rare steak in Polish.", level:3},
      {type:"missing-word", sentence:"Jedzenie byÅ‚o bardzo ___.", options:["smaczne","wolne","gÅ‚oÅ›ne","puste"], correct:0, explanation:"'Smaczne' means delicious in Polish.", level:1},
      {type:"tts", audioText:"Czy macie dzisiaj menu lunchowe?", topics:["Asking about lunch specials","Checking opening hours","Requesting takeout","Asking for reservations"], correct:0, explanation:"The speaker is asking about lunch specials in Polish.", level:2},
      {type:"missing-word", sentence:"Jestem ___ i nie jem miÄ™sa.", options:["wegetarianinem","szalonym","zagubionym","zirytowanym"], correct:0, explanation:"'Wegetarianinem' means vegetarian in Polish.", level:3}
    ]
  ]
},
travel: {
  name: "Travel & Directions",
  icon: "fa-plane",
  sets: [
    [
      {type:"missing-word", sentence:"Gdzie jest najbliÅ¼szy ___?", options:["dworzec","banan","niedÅºwiedÅº","ksiÄ…Å¼ka"], correct:0, explanation:"'Dworzec' means train station in Polish.", level:1},
      {type:"tts", audioText:"Przepraszam, jak dotrzeÄ‡ do muzeum? Czy jest daleko stÄ…d?", topics:["Asking for directions","Buying tickets","Checking into a hotel","Renting a car"], correct:0, explanation:"The speaker is asking how to get to the museum in Polish.", level:2},
      {type:"missing-word", sentence:"PotrzebujÄ™ ___ na trzy noce.", options:["pokoju","cukru","gazety","pociÄ…gu"], correct:0, explanation:"'Pokoju' means room (in a hotel) in Polish.", level:1},
      {type:"tts", audioText:"PociÄ…g do Krakowa odjeÅ¼dÅ¼a z toru 5. Uwaga, proszÄ™ siÄ™ pospieszyÄ‡!", topics:["Train announcements","Flight information","Bus schedules","Taxi services"], correct:0, explanation:"This is a train announcement about departure from platform 5 in Polish.", level:3},
      {type:"missing-word", sentence:"Ile kosztuje bilet do ___?", options:["Warszawy","psa","domu","rÄ™ki"], correct:0, explanation:"'Warszawy' is Warsaw, the capital of Poland.", level:1}
    ],
    [
      {type:"missing-word", sentence:"Czy moÅ¼esz mi pokazaÄ‡ na ___?", options:["mapie","ciÄ…gnÄ…Ä‡","liczyÄ‡","pÅ‚aciÄ‡"], correct:0, explanation:"'Mapie' means map in Polish.", level:1},
      {type:"tts", audioText:"ChciaÅ‚bym zarezerwowaÄ‡ prosty pokÃ³j z prysznicem i Å›niadaniem.", topics:["Booking a hotel room","Renting a car","Buying souvenirs","Asking for tourist info"], correct:0, explanation:"The speaker is booking a simple room with shower and breakfast in Polish.", level:3},
      {type:"missing-word", sentence:"Samolot ___ punktualnie.", options:["startuje","stoi","wznosi siÄ™","steruje"], correct:0, explanation:"'Startuje' means departs (for flights) in Polish.", level:2},
      {type:"tts", audioText:"Czy jest tu w pobliÅ¼u punkt informacji turystycznej?", topics:["Asking for tourist info","Looking for restaurants","Finding public transport","Locating pharmacies"], correct:0, explanation:"The speaker is asking for a tourist information office in Polish.", level:2},
      {type:"missing-word", sentence:"ZgubiÅ‚em swÃ³j ___.", options:["paszport","parasol","plecak","pierÅ›cionek"], correct:0, explanation:"'Paszport' means passport in Polish.", level:1}
    ]
  ]
},
family: {
  name: "Family & Friends",
  icon: "fa-users",
  sets: [
    [
      {type:"missing-word", sentence:"To jest moja ___.", options:["siostra","szkoÅ‚a","but","wÄ…Å¼"], correct:0, explanation:"'Siostra' means sister in Polish.", level:1},
      {type:"tts", audioText:"MÃ³j ojciec pracuje jako lekarz, a moja matka jest nauczycielkÄ….", topics:["Professions","Hobbies","Daily routine","Family members"], correct:3, explanation:"The speaker is talking about their parents (family members) in Polish.", level:2},
      {type:"missing-word", sentence:"Masz ___?", options:["rodzeÅ„stwo","prezenty","gitarÄ™","ogrÃ³d"], correct:0, explanation:"'RodzeÅ„stwo' means siblings in Polish.", level:2},
      {type:"tts", audioText:"Moi dziadkowie mieszkajÄ… w maÅ‚ej wsi na Mazurach.", topics:["Family members","Travel plans","Housing","Weather"], correct:0, explanation:"The speaker is talking about their grandparents (family members) in Polish.", level:3},
      {type:"missing-word", sentence:"Jutro obchodzimy urodziny ___.", options:["babci","owocÃ³w","piekarnika","ucha"], correct:0, explanation:"'Babci' means grandmother's in Polish.", level:1}
    ]
  ]
},
shopping: {
  name: "Shopping",
  icon: "fa-shopping-bag",
  sets: [
    [
      {type:"missing-word", sentence:"Ile kosztuje ta ___?", options:["kurtka","rok","chÅ‚opiec","jogurt"], correct:0, explanation:"'Kurtka' means jacket (clothing item) in Polish.", level:1},
      {type:"tts", audioText:"Czy macie te buty teÅ¼ w rozmiarze 42?", topics:["Asking for size","Returning items","Asking for price","Opening hours"], correct:0, explanation:"The speaker is asking if shoes are available in size 42 in Polish.", level:2},
      {type:"missing-word", sentence:"ChciaÅ‚bym te spodnie ___.", options:["wymieniÄ‡","uczyÄ‡","rozwaÅ¼aÄ‡","Ä‡wiczyÄ‡"], correct:0, explanation:"'WymieniÄ‡' means to exchange/return an item in Polish.", level:3},
      {type:"tts", audioText:"Kasa znajduje siÄ™ po lewej stronie sklepu.", topics:["Finding the cashier","Asking for discounts","Product availability","Store layout"], correct:0, explanation:"The speaker is being told where the cashier is located in Polish.", level:1},
      {type:"missing-word", sentence:"Czy jest tu jakaÅ› ___?", options:["zniÅ¼ka","deszcz","plecak","restauracja"], correct:0, explanation:"'ZniÅ¼ka' means discount in Polish.", level:2}
    ]
  ]
},
hobbies: {
  name: "Hobbies & Leisure",
  icon: "fa-film",
  sets: [
    [
      {type:"missing-word", sentence:"LubiÄ™ graÄ‡ na ___.", options:["pianinie","serze","skrzyni","kuli"], correct:0, explanation:"'Pianinie' means piano in Polish.", level:2},
      {type:"tts", audioText:"W sobotÄ™ idÄ™ do kina obejrzeÄ‡ nowy film Marvela.", topics:["Going to the movies","Reading books","Playing sports","Cooking"], correct:0, explanation:"The speaker is going to the cinema to watch a movie in Polish.", level:2},
      {type:"missing-word", sentence:"Moje hobby to ___.", options:["fotografia","okno","ryba","piÃ³ro"], correct:0, explanation:"'Fotografia' means photography in Polish.", level:3},
      {type:"tts", audioText:"Codziennie wieczorem przed snem czytam ksiÄ…Å¼kÄ™.", topics:["Reading","Writing","Painting","Dancing"], correct:0, explanation:"The speaker reads a book every evening before bed in Polish.", level:1},
      {type:"missing-word", sentence:"W weekend czÄ™sto chodzÄ™ ___.", options:["na spacery","czekaÄ‡","myÄ‡","Å¼yczyÄ‡"], correct:0, explanation:"'Na spacery' means for walks/hiking in Polish.", level:1}
    ]
  ]
}
};

// ==================== APP STATE ====================
let currentTopic = null;
let currentExercise = 0;
let points = 0;
let userAnswers = [];
let speechSynthesis = window.speechSynthesis;
let isDarkMode = localStorage.getItem('darkMode') === 'true';
let topicBestScores = JSON.parse(localStorage.getItem('terazPolskiBestScores')) || {};
let currentSetIndex = null;
let selectedLevel = 3;
let topicSetHistory = JSON.parse(localStorage.getItem('terazPolskiSetHistory')) || {};
let currentExercises = []; // FIX: Store the current exercises array

// ==================== DOM ELEMENTS ====================
const levelSelectionScreen = document.getElementById('level-selection-screen');
const topicSelectionScreen = document.getElementById('topic-selection-screen');
const exerciseContainer = document.getElementById('exercise-container');
const progressContainer = document.getElementById('progress-container');
const progressFill = document.getElementById('progress-fill');
const progressText = document.getElementById('progress-text');
const pointsDisplay = document.getElementById('points');
const completionScreen = document.getElementById('completion-screen');
const finalScore = document.getElementById('final-score');
const completionMessage = document.getElementById('completion-message');
const topicOptionsContainer = document.getElementById('topic-options-container');
const themeToggle = document.getElementById('theme-toggle');
const newTopicBtn = document.getElementById('new-topic-btn');
const restartTopicBtn = document.getElementById('restart-topic-btn');
const levelSelector = document.getElementById('level-selector');
const levelDescription = document.getElementById('level-description');
const proceedToTopicsBtn = document.getElementById('proceed-to-topics-btn');
const currentLevelBadge = document.getElementById('current-level-badge');
const backToLevelsBtn = document.getElementById('back-to-levels-btn');

// ==================== HELPER FUNCTIONS ====================
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

function randomizeOptions(options, correctIndex) {
    const correctAnswer = options[correctIndex];
    const incorrectAnswers = options.filter((_, i) => i !== correctIndex);
    const shuffledIncorrect = shuffleArray(incorrectAnswers);
    
    const correctPos = Math.floor(Math.random() * options.length);
    const newOptions = [];
    let incorrectIndex = 0;
    
    for (let i = 0; i < options.length; i++) {
        if (i === correctPos) {
            newOptions.push(correctAnswer);
        } else {
            newOptions.push(shuffledIncorrect[incorrectIndex++]);
        }
    }
    
    return { 
        options: newOptions, 
        correctIndex: newOptions.indexOf(correctAnswer) 
    };
}

function selectRandomSet(topicKey) {
    const topic = allTopics[topicKey];
    if (!topic) return 0;
    
    // Initialize history if needed
    if (!topicSetHistory[topicKey]) {
        topicSetHistory[topicKey] = [];
    }
    
    const numSets = topic.sets.length;
    
    // Get available sets (not in last 2 used)
    const availableSets = [];
    for (let i = 0; i < numSets; i++) {
        if (!topicSetHistory[topicKey].slice(-2).includes(i)) {
            availableSets.push(i);
        }
    }
    
    // If all sets were recently used, reset history
    if (availableSets.length === 0) {
        topicSetHistory[topicKey] = [];
        for (let i = 0; i < numSets; i++) {
            availableSets.push(i);
        }
    }
    
    // Select random from available
    const randomIndex = availableSets[Math.floor(Math.random() * availableSets.length)];
    
    // Update history
    topicSetHistory[topicKey].push(randomIndex);
    localStorage.setItem('terazPolskiSetHistory', JSON.stringify(topicSetHistory));
    
    return randomIndex;
}

function filterExercisesByLevel(exercises) {
    return exercises.filter(exercise => exercise.level <= selectedLevel);
}

function scrollToNextButton() {
  setTimeout(() => {
    const nextBtn = document.querySelector('.btn-next');
    if (nextBtn) {
      nextBtn.scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'nearest'
      });
      setTimeout(() => nextBtn.focus(), 300);
    }
  }, 150);
}

function applyTheme() {
    const root = document.documentElement;
    if (isDarkMode) {
        root.style.setProperty('--bg', 'var(--dark-bg)');
        root.style.setProperty('--text', 'var(--text-dark)');
        root.style.setProperty('--subheading', 'var(--subheading-dark)');
        root.style.setProperty('--card', 'var(--card-dark)');
        root.style.setProperty('--border', 'var(--border-dark)');
        root.style.setProperty('--option-bg', 'var(--option-bg-dark)');
        root.style.setProperty('--bg-sentence', 'rgba(30, 41, 59, 0.7)');
        root.style.setProperty('--shadow', 'var(--shadow-dark)');
        root.style.setProperty('--feedback-correct', 'var(--feedback-correct-dark)');
        root.style.setProperty('--feedback-correct-text', 'white');
        root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-dark)');
        root.style.setProperty('--feedback-incorrect-text', 'white');
        root.style.setProperty('--warning', '#fbbf24');
    } else {
        root.style.setProperty('--bg', 'var(--light-bg)');
        root.style.setProperty('--text', 'var(--text-light)');
        root.style.setProperty('--subheading', 'var(--subheading-light)');
        root.style.setProperty('--card', 'var(--card-light)');
        root.style.setProperty('--border', 'var(--border-light)');
        root.style.setProperty('--option-bg', 'var(--option-bg-light)');
        root.style.setProperty('--bg-sentence', '#f1f5ff');
        root.style.setProperty('--shadow', 'var(--shadow-light)');
        root.style.setProperty('--feedback-correct', 'var(--feedback-correct-light)');
        root.style.setProperty('--feedback-correct-text', 'var(--text-light)');
        root.style.setProperty('--feedback-incorrect', 'var(--feedback-incorrect-light)');
        root.style.setProperty('--feedback-incorrect-text', 'var(--text-light)');
        root.style.setProperty('--warning', '#f8961e');
    }
}

function speakText(text) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'pl-PL';
    utterance.rate = 0.9;
    utterance.pitch = 1;
    speechSynthesis.speak(utterance);
}

// ==================== INITIALIZATION ====================
applyTheme();

// Theme toggle
themeToggle.addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    localStorage.setItem('darkMode', isDarkMode);
    applyTheme();
    
    const icon = themeToggle.querySelector('i');
    icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
});

// Level selection
levelSelector.addEventListener('change', (e) => {
    selectedLevel = parseInt(e.target.value);
    const levelInfo = VOCABULARY_LEVELS[selectedLevel];
    levelDescription.textContent = levelInfo.description;
});

proceedToTopicsBtn.addEventListener('click', () => {
    levelSelectionScreen.classList.add('hidden');
    topicSelectionScreen.classList.remove('hidden');
    currentLevelBadge.textContent = `Level ${selectedLevel}`;
    renderTopicSelection();
});

backToLevelsBtn.addEventListener('click', () => {
    topicSelectionScreen.classList.add('hidden');
    levelSelectionScreen.classList.remove('hidden');
});

// Initialize with default level description
levelDescription.textContent = VOCABULARY_LEVELS[selectedLevel].description;

// ==================== MAIN APP FUNCTIONS ====================
function renderTopicSelection() {
    topicOptionsContainer.innerHTML = '';
    
    Object.keys(allTopics).forEach(topicKey => {
        const topic = allTopics[topicKey];
        const bestScore = topicBestScores[topicKey] || 0;
        
        // Count accessible exercises for this topic at current level
        let accessibleExerciseCount = 0;
        topic.sets.forEach(set => {
            const filtered = filterExercisesByLevel(set);
            accessibleExerciseCount += filtered.length;
        });
        
        const topicOption = document.createElement('div');
        topicOption.className = 'topic-option';
        topicOption.dataset.topic = topicKey;
        topicOption.innerHTML = `
            <i class="fas ${topic.icon}"></i>
            ${topic.name}
            ${bestScore > 0 ? `<div class="score-badge">${Math.round(bestScore)}</div>` : ''}
            <div style="margin-top: 10px; font-size: 0.8rem; color: var(--secondary);">
                ${accessibleExerciseCount}+ exercises
            </div>
        `;
        
        topicOption.addEventListener('click', () => startTopicExercises(topicKey));
        topicOptionsContainer.appendChild(topicOption);
    });
}

function startTopicExercises(topicKey) {
    topicSelectionScreen.classList.add('hidden');
    progressContainer.classList.remove('hidden');
    exerciseContainer.classList.remove('hidden');
    completionScreen.classList.add('hidden');
    
    currentTopic = topicKey;
    currentExercise = 0;
    points = 0;
    userAnswers = [];
    
    currentSetIndex = selectRandomSet(topicKey);
    
    // Get exercises from selected set and filter by level
    const allSets = allTopics[topicKey].sets;
    const selectedSet = allSets[currentSetIndex] || allSets[0];
    
    // Filter exercises by level
    currentExercises = filterExercisesByLevel(selectedSet);
    
    // If we don't have 5 exercises, try to get more from other sets
    if (currentExercises.length < 5) {
        const additionalExercises = [];
        allSets.forEach((set, index) => {
            if (index !== currentSetIndex) {
                const filtered = filterExercisesByLevel(set);
                filtered.forEach(exercise => {
                    if (additionalExercises.length < (5 - currentExercises.length)) {
                        additionalExercises.push(exercise);
                    }
                });
            }
        });
        currentExercises.push(...additionalExercises);
    }
    
    // Limit to maximum 5 exercises
    currentExercises = currentExercises.slice(0, 5);
    
    // Reset user answers for the new set
    userAnswers = new Array(currentExercises.length).fill(null);
    
    pointsDisplay.textContent = points;
    updateProgress();
    loadExercise();
}

function loadExercise() {
    const topicData = allTopics[currentTopic];
    const exercise = currentExercises[currentExercise];
    
    if (!exercise) {
        exerciseContainer.innerHTML = `
            <div class="exercise-content" style="text-align: center;">
                <h3>No exercises available at your current level</h3>
                <p>Try selecting a higher vocabulary level or a different topic.</p>
                <button class="btn btn-next" onclick="showTopicSelection()" style="margin-top: 20px;">
                    Back to Topics
                </button>
            </div>
        `;
        return;
    }
    
    exerciseContainer.innerHTML = '';
    
    const titleContainer = document.createElement('div');
    titleContainer.className = 'exercise-title';
    titleContainer.innerHTML = `
        <span><i class="fas fa-${exercise.type === 'missing-word' ? 'puzzle-piece' : 'headphones'}"></i> ${exercise.type === 'missing-word' ? 'Fill in the Blank' : 'Listen & Identify Topic'}</span>
        <div>
            <span class="topic-name">${topicData.name}</span>
            <span class="level-badge" style="font-size: 0.8rem; margin-right: 10px;">Level ${exercise.level}</span>
            <button class="back-btn" id="back-to-topics-btn">
                <i class="fas fa-arrow-left"></i> Topics
            </button>
        </div>
    `;
    exerciseContainer.appendChild(titleContainer);
    
    setTimeout(() => {
        const backBtn = document.getElementById('back-to-topics-btn');
        if (backBtn) {
            backBtn.addEventListener('click', showTopicSelection);
        }
    }, 0);
    
    // Store randomized options on the exercise object
    if (exercise.type === 'missing-word') {
        if (!exercise.currentOptions) {
            const randomized = randomizeOptions(exercise.options, exercise.correct);
            exercise.currentOptions = randomized.options;
            exercise.currentCorrect = randomized.correctIndex;
        }
    }
    
    if (exercise.type === 'tts') {
        if (!exercise.currentTopics) {
            const topics = [...exercise.topics];
            const correctTopic = topics[exercise.correct];
            const shuffledTopics = shuffleArray(topics);
            const newCorrectIndex = shuffledTopics.indexOf(correctTopic);
            
            exercise.currentTopics = shuffledTopics;
            exercise.currentCorrect = newCorrectIndex;
        }
    }
    
    if (exercise.type === 'missing-word') {
        renderMissingWordExercise(exercise);
    } else if (exercise.type === 'tts') {
        renderTTsExercise(exercise);
    }
}

function renderMissingWordExercise(exercise) {
    const content = document.createElement('div');
    content.className = 'exercise-content missing-word-exercise';
    
    const sentence = document.createElement('div');
    sentence.className = 'sentence';
    sentence.textContent = exercise.sentence;
    content.appendChild(sentence);
    
    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'options-container';
    
    const options = exercise.currentOptions;
    const correctIndex = exercise.currentCorrect;
    
    options.forEach((option, index) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'option-btn';
        optionBtn.textContent = option;
        optionBtn.dataset.index = index;
        
        if (userAnswers[currentExercise] !== undefined && userAnswers[currentExercise] !== null) {
            optionBtn.disabled = true;
            if (index === userAnswers[currentExercise]) {
                optionBtn.classList.add('selected');
                if (index === correctIndex) {
                    optionBtn.classList.add('correct');
                } else {
                    optionBtn.classList.add('incorrect');
                }
            } else if (index === correctIndex) {
                optionBtn.classList.add('correct');
            }
        }
        
        optionBtn.addEventListener('click', () => handleMissingWordAnswer(index, correctIndex, exercise));
        optionsContainer.appendChild(optionBtn);
    });
    
    content.appendChild(optionsContainer);
    
    const feedback = document.createElement('div');
    feedback.className = 'feedback';
    feedback.id = 'feedback';
    content.appendChild(feedback);
    
    exerciseContainer.appendChild(content);
    addNavigation();
}

function handleMissingWordAnswer(selectedIndex, correctIndex, exercise) {
    userAnswers[currentExercise] = selectedIndex;
    
    if (selectedIndex === correctIndex) {
        points += 10;
        pointsDisplay.textContent = points;
    }
    
    const buttons = document.querySelectorAll('.option-btn');
    buttons.forEach((btn, index) => {
        btn.disabled = true;
        if (index === selectedIndex) {
            btn.classList.add('selected');
            if (index === correctIndex) {
                btn.classList.add('correct');
            } else {
                btn.classList.add('incorrect');
            }
        } else if (index === correctIndex) {
            btn.classList.add('correct');
        }
    });
    
    const feedback = document.getElementById('feedback');
    if (selectedIndex === correctIndex) {
        feedback.textContent = `Correct! ${exercise.explanation}`;
        feedback.className = 'feedback correct';
        const fullCorrectSentence = exercise.sentence.replace("___", exercise.options[exercise.correct]);
        setTimeout(() => speakText(fullCorrectSentence), 500);
    } else {
        feedback.textContent = `Incorrect. ${exercise.explanation}`;
        feedback.className = 'feedback incorrect';
        const fullCorrectSentence = exercise.sentence.replace("___", exercise.options[exercise.correct]);
        setTimeout(() => speakText(fullCorrectSentence), 1000);
    }
    
    document.querySelector('.btn-next').disabled = false;
    scrollToNextButton();
}

function renderTTsExercise(exercise) {
    const content = document.createElement('div');
    content.className = 'exercise-content tts-exercise';
    
    const instruction = document.createElement('p');
    instruction.textContent = 'Listen to the Polish sentence and select the correct topic:';
    instruction.style.marginBottom = '20px';
    instruction.style.fontSize = '1.1rem';
    content.appendChild(instruction);
    
    const audioControls = document.createElement('div');
    audioControls.className = 'audio-controls';
    
    const playBtn = document.createElement('button');
    playBtn.className = 'play-btn';
    playBtn.innerHTML = '<i class="fas fa-play"></i>';
    playBtn.title = 'Play audio';
    
    playBtn.addEventListener('click', () => {
        speakText(exercise.audioText);
        playBtn.disabled = true;
        setTimeout(() => {
            playBtn.disabled = false;
        }, 5000);
    });
    
    audioControls.appendChild(playBtn);
    content.appendChild(audioControls);
    
    const topicsContainer = document.createElement('div');
    topicsContainer.className = 'topics-container';
    
    const topics = exercise.currentTopics;
    const correctIndex = exercise.currentCorrect;
    
    topics.forEach((topic, index) => {
        const topicCard = document.createElement('div');
        topicCard.className = 'topic-card';
        topicCard.textContent = topic;
        topicCard.dataset.index = index;
        
        if (userAnswers[currentExercise] !== undefined && userAnswers[currentExercise] !== null) {
            topicCard.classList.add('locked');
            if (index === userAnswers[currentExercise]) {
                topicCard.classList.add('selected');
            }
            if (userAnswers[currentExercise] !== correctIndex && index === correctIndex) {
                topicCard.classList.add('correct');
            }
        }
        
        topicCard.addEventListener('click', () => handleTTSAnswer(index, correctIndex, exercise));
        topicsContainer.appendChild(topicCard);
    });
    
    content.appendChild(topicsContainer);
    
    const feedback = document.createElement('div');
    feedback.className = 'feedback';
    feedback.id = 'feedback';
    content.appendChild(feedback);
    
    exerciseContainer.appendChild(content);
    addNavigation();
}

function handleTTSAnswer(selectedIndex, correctIndex, exercise) {
    userAnswers[currentExercise] = selectedIndex;
    
    if (selectedIndex === correctIndex) {
        points += 10;
        pointsDisplay.textContent = points;
    }
    
    const cards = document.querySelectorAll('.topic-card');
    cards.forEach((card, index) => {
        card.classList.add('locked');
        if (index === selectedIndex) {
            card.classList.add('selected');
        }
        if (index === correctIndex) {
            card.classList.add('correct');
        }
    });
    
    const feedback = document.getElementById('feedback');
    if (selectedIndex === correctIndex) {
        feedback.textContent = `Correct! ${exercise.explanation}`;
        feedback.className = 'feedback correct';
    } else {
        feedback.textContent = `Incorrect. ${exercise.explanation}`;
        feedback.className = 'feedback incorrect';
    }
    
    document.querySelector('.btn-next').disabled = false;
    scrollToNextButton();
}

function addNavigation() {
    const nav = document.createElement('div');
    nav.className = 'navigation';
    
    const prevBtn = document.createElement('button');
    prevBtn.className = 'btn btn-prev';
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = currentExercise === 0;
    prevBtn.addEventListener('click', () => {
        if (currentExercise > 0) {
            currentExercise--;
            loadExercise();
            updateProgress();
        }
    });
    
    const nextBtn = document.createElement('button');
    nextBtn.className = 'btn btn-next';
    nextBtn.textContent = currentExercise === currentExercises.length - 1 ? 'Finish Topic' : 'Next';
    nextBtn.disabled = userAnswers[currentExercise] === undefined || userAnswers[currentExercise] === null;
    nextBtn.addEventListener('click', () => {
        if (currentExercise < currentExercises.length - 1) {
            currentExercise++;
            loadExercise();
            updateProgress();
        } else {
            finishTopic();
        }
    });
    
    nav.appendChild(prevBtn);
    nav.appendChild(nextBtn);
    exerciseContainer.appendChild(nav);
}

function updateProgress() {
    const totalExercises = currentExercises.length;
    const progress = ((currentExercise + 1) / totalExercises) * 100;
    progressFill.style.width = `${progress}%`;
    progressText.textContent = `${currentExercise + 1}/${totalExercises}`;
}

function finishTopic() {
  if (points > (topicBestScores[currentTopic] || 0)) {
    topicBestScores[currentTopic] = points;
    localStorage.setItem('terazPolskiBestScores', JSON.stringify(topicBestScores));
  }

  let message = "Keep practicing! ðŸ“š";
  let color = "#f8961e";
  if (points >= (currentExercises.length * 10 * 0.9) { // 90% or more
    message = "Outstanding! ðŸŒŸ";
    color = "#4ade80";
  } else if (points >= (currentExercises.length * 10 * 0.7) { // 70% or more
    message = "Great job! ðŸ‘";
    color = "#4cc9f0";
  } else if (points >= (currentExercises.length * 10 * 0.5) { // 50% or more
    message = "Good effort! ðŸ’ª";
    color = "#f8961e";
  }

  completionMessage.textContent = message;
  completionMessage.style.color = color;

  exerciseContainer.classList.add('hidden');
  progressContainer.classList.add('hidden');
  finalScore.textContent = points;
  completionScreen.classList.remove('hidden');
}

function showTopicSelection() {
    completionScreen.classList.add('hidden');
    exerciseContainer.classList.add('hidden');
    progressContainer.classList.add('hidden');
    topicSelectionScreen.classList.remove('hidden');
    renderTopicSelection();
}

// Initialize button handlers
newTopicBtn.addEventListener('click', showTopicSelection);
restartTopicBtn.addEventListener('click', () => {
    completionScreen.classList.add('hidden');
    startTopicExercises(currentTopic);
});

// Initialize app
window.addEventListener('load', () => {
    levelSelectionScreen.classList.remove('hidden');
});
</script>
</body>
</html>